@using Vikalp.Models.DTO
@model Vikalp.Models.DTO.HomeVisitDTO

@{
    ViewData["Title"] = "Add Home Visit";
    Layout = "~/Views/Shared/_AdminLayout.cshtml";
}

<style>
    #linelistForm {
        padding: 20px;
        max-width: 1400px;
        margin: 0 auto;
    }

    /* Facility Type Section */
    .form-card {
        background: #fff;
        border-radius: 8px;
        padding: 10px;
        margin-bottom: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .section-title {
        align-items: center;
        gap: 15px;
        margin-bottom: 20px;
        font-size: 18px;
        font-weight: 600;
        color: #333;
    }

        .section-title i {
            font-size: 24px;
            color: #0d6efd;
        }

    .fh-header {
        display: flex;
        gap: 20px;
        margin-left: auto;
    }

    .facility-type-card {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 5px 19px;
        border: 2px solid #dee2e6;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s ease;
        background: #f8f9fa;
    }



        .facility-type-card input[type="radio"] {
            cursor: pointer;
            width: 18px;
            height: 18px;
        }

        .facility-type-card label {
            cursor: pointer;
            margin: 0;
            font-size: 15px;
            font-weight: 500;
        }

    /* Card Header Section */
    .card {
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        margin-bottom: 20px;
    }

    .fh-cardHeader {
        align-items: center;
        justify-content: space-between;
        padding: 10px 0;
    }

        .fh-cardHeader h2 {
            margin: 0;
            font-size: 18px;
            font-weight: 600;
            color: #F15A29;
        }

        .fh-cardHeader .col-md-4 {
            display: flex;
            align-items: center;
            gap: 12px;
        }

            .fh-cardHeader .col-md-4 label {
                white-space: nowrap;
                margin: 0;
                font-weight: 500;
                min-width: 120px;
            }

            .fh-cardHeader .col-md-4 input {
                flex: 1;
            }


    .btn {
        padding: 8px;
        font-weight: 500;
    }

    .btn-success {
        margin: 0;
    }



    /* Hidden utility */
    .d-none {
        display: none !important;
    }

    .fh-section-title {
        align-items: center;
        gap: 15px;
        /* margin-bottom: 20px; */
        font-size: 14px;
        font-weight: 600;
        color: #333;
    }

    .fh-cardBody {
        padding: 1px 10px;
        flex: 1 1 auto;
    }

    .btn-topics {
        height: 32px;
        line-height: 15px;
    }

    .table thead tr th, .table tbody tr th {
        vertical-align: middle;
    }

    .fh-modal-header {
        color: #F15A29;
    }
</style>

<form asp-action="Create" method="post" id="linelistForm">
    @Html.AntiForgeryToken()
    <input type="hidden" id="hdnLineListGuid" name="LineListGuid" value="@Model.LineListGuid" />
    <input type="hidden" id="hdnDistrictId" name="DistrictId" value="@Model.DistrictId" />
    <input type="hidden" id="hdnBlockId" name="BlockId" value="@Model.BlockId" />
    <input type="hidden" id="hdnFacilityId" name="FacilityId" value="@Model.FacilityId" />
    <input type="hidden" id="hdnSubCenterId" name="SubCenterId" value="@Model.SubCenterId" />
    <input type="hidden" id="hdnAshaId" name="ASHAId" value="@Model.ASHAId" />

    <div class="card">
        <div class="fh-cardBody">
            <div class="fh-cardHeader d-flex gap-5">
                <h2 class="mb-3">Add Member</h2>
                @{
                    var today = DateTime.Today;
                    var minDate = today.AddDays(-5).ToString("yyyy-MM-dd");
                    var maxDate = today.ToString("yyyy-MM-dd");
                }
                <div class="col-md-4 d-flex">
                    <label>Visit Date</label>
                    <input type="date"
                           name="CreatedOn"
                           value="@Model.CreatedOn?.ToString("yyyy-MM-dd")"
                           class="form-control"
                           min="@minDate" max="@maxDate" />
                    <span asp-validation-for="CreatedOn" class="text-danger"></span>

                </div>
            </div>
        </div>
    </div>
    <div class="row mb-2">
        <div class="col-md-2">
            <label>State</label>
            <select name="StateId" class="form-control" id="StateId" required>
                <option value="">-- Select State --</option>
                @foreach (var s in ViewBag.States)
                {
                    <option value="@s.Id" @(Model.StateId == s.Id ? "selected" : "")>@s.Name</option>
                }
            </select>
        </div>

        <div class="col-md-2">
            <label>District</label>
            <select name="DistrictId" class="form-control" id="DistrictId">
                <option value="">-- Select District --</option>
            </select>
        </div>

        <div class="col-md-2">
            <label>Block</label>
            <select name="BlockId" class="form-control" id="BlockId">
                <option value="">-- Select Block --</option>
            </select>
        </div>

        <div class="col-md-2">
            <label>Facility</label>
            <select name="FacilityId" class="form-control" id="FacilityId">
                <option value="">-- Select Facility --</option>
            </select>
        </div>

        <div class="col-md-2">
            <label>Sub Centre</label>
            <select name="SubCenterId" class="form-control" id="SubCenterId">
                <option value="">-- Select Sub-centre --</option>
            </select>
        </div>

        <div class="col-md-2">
            <label>ASHA Name</label>
            <select name="AshaId" class="form-control" id="AshaId">
                <option value="">-- Select ASHA --</option>
            </select>
        </div>
    </div>
    <div class="row mb-2">
        <div class="col-md-2">
            <label>Anganwadi Worker</label>
            <input type="text" name="AnganwadiWorkerName" value="@Model.AnganwadiWorkerName" class="form-control" placeholder="Enter AWC name" />
        </div>

        <div class="col-md-2">
            <label>Village Name</label>
            <input type="text" name="VillageName" value="@Model.VillageName" class="form-control" placeholder="Enter Village name" />
        </div>

        <div class="col-md-2">
            <label>Name of Woman</label>
            <input name="WomanName" value="@Model.WomanName" class="form-control" required>
        </div>

        <div class="col-md-2">
            <label>Husband’s Name</label>
            <input name="HusbandName" value="@Model.HusbandName" class="form-control">
        </div>

        <div class="col-md-2">
            <label>Mobile Number</label>
            <input name="MobileNumber" id="MobileNumber" value="@Model.MobileNumber" class="form-control" maxlength="10" required pattern="[0-9]{10}">
            <small id="mobileError" class="text-danger d-none">
                Enter valid 10-digit mobile number
            </small>
        </div>

        <div class="col-md-2">
            <label>Client Parity</label>
            <input id="ClientParity" name="ClientParity" class="form-control" type="number" maxlength="1">
        </div>
    </div>
    <div class="row mb-2">
        <div class="row align-items-center mb-2">
            <div class="col-md-4 fw-semibold">
                <label>Are you currently pregnant?</label>
            </div>
            <div class="col-md-8">
                <select name="IsCurrentlyPregnant" class="form-control" id="IsCurrentlyPregnant">
                    <option value="">-- Select --</option>
                    @foreach (var s in ViewBag.yesNo)
                    {
                        <option value="@s.Value" @(Model.IsCurrentlyPregnant.ToString() == s.Value ? "selected" : "")>@s.Text</option>
                    }
                </select>
            </div>
        </div>

        <div class="row align-items-center mb-2">
            <div class="col-md-4 fw-semibold">
                <label>Are you Receiving IEC?</label>
            </div>
            <div class="col-md-8">
                <select name="IsReceivingSocialBenefit" class="form-control" id="IsReceivingSocialBenefit">
                    <option value="">-- Select --</option>
                    @foreach (var s in ViewBag.yesNo)
                    {
                        <option value="@s.Value" @(Model.IsReceivingSocialBenefit.ToString() == s.Value ? "selected" : "")>@s.Text</option>
                    }
                </select>
            </div>
        </div>

        <div id="iecMethodSection" class="row align-items-center mb-2">
            <div class="col-md-4 fw-semibold">
                <label>Which IEC are you using?</label>
            </div>
            <div class="col-md-8">

                <div class="dropdown">
                    <button class="form-control dropdown-toggle w-100 text-start"
                            type="button"
                            data-bs-toggle="dropdown"
                            aria-expanded="false">
                        Select Method
                    </button>

                    <ul class="dropdown-menu w-100 px-2" style="max-height: 200px; overflow-y: auto;">
                        @{
                            var socialbenifits =
                            ViewBag.socialbenifit as List<SelectListItem>;
                        }

                        @if (socialbenifits != null)
                        {
                            foreach (var s in socialbenifits)
                            {
                                <li>
                                    <div class="form-check">
                                        <input class="form-check-input"
                                               type="checkbox"
                                               name="SocialBenifits"
                                               value="@s.Value"
                                               id="fp_@s.Value"
                                               @(Model.SocialBenifits != null &&
                                                                                      Model.SocialBenifits.Contains(int.Parse(s.Value)) ? "checked" : "") />
                                <label class="form-check-label" for="fp_@s.Value">
                                    @s.Text
                                </label>
                            </div>
                        </li>
                                                }
                        }
                    </ul>
                </div>
            </div>
        </div>

        <div class="row align-items-center mb-2">
            <div class="col-md-4 fw-semibold">
                <label>Are you using any family planning method?</label>
            </div>
            <div class="col-md-8">
                <select name="IsUsingFamilyPlanning" class="form-control" id="IsUsingFamilyPlanning">
                    <option value="">-- Select --</option>
                    @foreach (var s in ViewBag.yesNo)
                    {
                        <option value="@s.Value" @(Model.IsUsingFamilyPlanning.ToString() == s.Value ? "selected" : "")>@s.Text</option>
                    }
                </select>
            </div>
        </div>

        <div id="fpMethodSection" class="row align-items-center mb-2">
            <div class="col-md-4 fw-semibold">
                <label>Which family planning method are you using?</label>
            </div>
            <div class="col-md-8">
                <select name="FamilyPlanningMethod" class="form-control" id="FamilyPlanningMethod">
                    <option value="">-- Select --</option>
                    @foreach (var s in ViewBag.familyplanning)
                    {
                        <option value="@s.Value" @(Model.FamilyPlanningMethod.ToString() == s.Value ? "selected" : "")>@s.Text</option>
                    }
                </select>
            </div>
        </div>

        <div id="fpMethodNotSection" class="row align-items-center mb-2">
            <div class="col-md-4 fw-semibold">
                <label>If not, was mutual discussion/counseling done</label>
            </div>
            <div class="col-md-8">
                <select name="IsCounsellingDone" class="form-control" id="IsCounsellingDone">
                    <option value="">-- Select --</option>
                    @foreach (var s in ViewBag.yesNo)
                    {
                        <option value="@s.Value" @(Model.IsCounsellingDone.ToString() == s.Value ? "selected" : "")>@s.Text</option>
                    }
                </select>
            </div>
        </div>

        <div class="row align-items-center mb-2">
            <div class="col-md-4 fw-semibold">
                <label>Referred to the health center to receive the required services?</label>
            </div>
            <div class="col-md-8">
                <select name="IsReferredForServices" class="form-control" id="IsReferredForServices">
                    <option value="">-- Select --</option>
                    @foreach (var s in ViewBag.yesNo)
                    {
                        <option value="@s.Value" @(Model.IsReferredForServices.ToString() == s.Value ? "selected" : "")>@s.Text</option>
                    }
                </select>
            </div>
        </div>
        <div id="ifreffered">
        <div class="row align-items-center mb-2">
            <div class="col-md-4 fw-semibold">
                <label>Referred Facility Type?</label>
            </div>
            <div class="col-md-8">
                <select name="ReferredHealthCenterType" class="form-control" id="ReferredHealthCenterType">
                    <option value="">-- Select Facility Type --</option>
                    @foreach (var s in (IEnumerable<SelectListItem>)ViewBag.FacilityType)
                    {
                        <option value="@s.Value" @(Model.ReferredHealthCenterType.ToString() == s.Value ? "selected" : "")>
                            @s.Text
                        </option>
                    }
                </select>
            </div>
        </div>

        <div class="row align-items-center mb-2">
            <div class="col-md-4 fw-semibold">
                <label>Write the name of the referred health center</label>
            </div>
            <div class="col-md-8">
                    <input id="ReferredHealthCenterName" name="ReferredHealthCenterName" class="form-control">
            </div>
        </div>
        </div>
    </div>
    @*  <button type="button" class="btn-save" onclick="saveMembers()">Save</button> *@

    <button type="button" id="btnSave" class="btn-save" onclick="saveMembers()">
        <span id="btnText">Save</span>
        <span id="btnLoader" class="spinner-border spinner-border-sm d-none"></span>
    </button>
    <a href="@Url.Action("Index", "HomeVisit")" class="btn-back">Back</a>
</form>



@section Scripts {
    <script>
                document.addEventListener("DOMContentLoaded", function () {
            //let linelistguid = document.getElementById("hdnLineListGuid").value;
            let stateId = document.getElementById("StateId").value;
            let districtId = document.getElementById("hdnDistrictId").value;
            let blockId = document.getElementById("hdnBlockId").value;
            let facilityId = document.getElementById("hdnFacilityId").value;
            let subCenterId = document.getElementById("hdnSubCenterId").value;
            let ashaId = document.getElementById("hdnAshaId").value;

            if (stateId) {

                fetch(`/HomeVisit/GetDistricts?stateId=${stateId}`)
                    .then(res => res.json())
                    .then(data => {
                        fillDropdown("DistrictId", data, "id", "name", districtId);

                        if (districtId) {
                            return fetch(`/HomeVisit/GetBlocks?districtId=${districtId}`);
                        }
                    })
                    .then(res => res ? res.json() : null)
                    .then(data => {
                        if (data) {
                            fillDropdown("BlockId", data, "id", "name", blockId);

                            if (blockId) {
                                return fetch(`/HomeVisit/GetFacilities?blockId=${blockId}`);
                            }
                        }
                    })
                    .then(res => res ? res.json() : null)
                    .then(data => {
                        if (data) {
                            fillDropdown("FacilityId", data, "id", "name", facilityId);

                            if (blockId) {
                                return fetch(`/HomeVisit/GetSubCentre?blockId=${blockId}`);
                            }
                        }
                    })
                    .then(res => res ? res.json() : null)
                    .then(data => {
                        if (data) {
                            fillDropdown("SubCenterId", data, "id", "name", subCenterId);

                            if (subCenterId) {
                                return fetch(`/HomeVisit/GetAshabySubcentre?subcentreId=${subCenterId}`);
                            }
                        }
                    })
                    .then(res => res ? res.json() : null)
                    .then(data => {
                        if (data) {
                            fillDropdown("AshaId", data, "id", "name", ashaId);
                        }
                    });
            }

            // =================== CASCADE CHANGE EVENTS ===================

            document.getElementById("StateId")
                .addEventListener("change", loadDistricts);

            document.getElementById("DistrictId")
                .addEventListener("change", loadBlocks);

            document.getElementById("BlockId")
                .addEventListener("change", loadFacilitiesAndSubCenters);

            document.getElementById("SubCenterId")
                .addEventListener("change", loadAshas);


            async function loadDistricts() {
                let stateId = this.value;
                clearDropdown("DistrictId");
                clearDropdown("BlockId");
                clearDropdown("FacilityId");
                clearDropdown("SubCenterId");
                clearDropdown("AshaId");

                if (!stateId) return;

                let res = await fetch(`/HomeVisit/GetDistricts?stateId=${stateId}`);
                let data = await res.json();
                fillDropdown("DistrictId", data, "id", "name");
            }

            async function loadBlocks() {
                let districtId = this.value;
                clearDropdown("BlockId");
                clearDropdown("FacilityId");
                clearDropdown("SubCenterId");
                clearDropdown("AshaId");

                if (!districtId) return;

                let res = await fetch(`/HomeVisit/GetBlocks?districtId=${districtId}`);
                let data = await res.json();
                fillDropdown("BlockId", data, "id", "name");
            }

            async function loadFacilitiesAndSubCenters() {
                let blockId = this.value;
                clearDropdown("FacilityId");
                clearDropdown("SubCenterId");
                clearDropdown("AshaId");

                if (!blockId) return;

                let facilityRes = await fetch(`/HomeVisit/GetFacilities?blockId=${blockId}`);
                let facilityData = await facilityRes.json();
                fillDropdown("FacilityId", facilityData, "id", "name");

                let subRes = await fetch(`/HomeVisit/GetSubCentre?blockId=${blockId}`);
                let subData = await subRes.json();
                fillDropdown("SubCenterId", subData, "id", "name");
            }

            async function loadAshas() {
                let subId = this.value;
                clearDropdown("AshaId");

                if (!subId) return;

                let res = await fetch(`/HomeVisit/GetAshabySubcentre?subcentreId=${subId}`);
                let data = await res.json();
                fillDropdown("AshaId", data, "id", "name");
            }


            // =================== COMMON FUNCTIONS ===================

            function fillDropdown(dropdownId, data, valueField, textField, selectedValue = null) {
                let dropdown = document.getElementById(dropdownId);
                dropdown.innerHTML = '<option value="">-- Select --</option>';

                data.forEach(item => {
                    let option = document.createElement("option");
                    option.value = item[valueField];
                    option.text = item[textField];

                    if (selectedValue && selectedValue == item[valueField]) {
                        option.selected = true;
                    }

                    dropdown.appendChild(option);
                });
            }

            function clearDropdown(dropdownId) {
                document.getElementById(dropdownId).innerHTML =
                    '<option value="">-- Select --</option>';
            }



        //=========================Show hide logic=========================

                document.getElementById("IsUsingFamilyPlanning")
            .addEventListener("change", toggleSections);

        document.getElementById("IsReceivingSocialBenefit")
            .addEventListener("change", toggleSections);

        document.addEventListener("DOMContentLoaded", toggleSections);

                function toggleSections() {

            let isFP = document.getElementById("IsUsingFamilyPlanning").value;
            let isIEC = document.getElementById("IsReceivingSocialBenefit").value;

            document.getElementById("fpMethodSection")
                .classList.toggle("d-none", isFP !== "1");

            document.getElementById("iecMethodSection")
                .classList.toggle("d-none", isIEC !== "1");
        }


        //======================mobile validation===========

                function validateMobile() {

            let mobile = document.getElementById("MobileNumber").value;
            let error = document.getElementById("mobileError");

            let isValid = /^[6-9]\d{9}$/.test(mobile);

            error.classList.toggle("d-none", isValid || mobile.length === 0);

            return isValid;
        }

        document.getElementById("MobileNumber")
            .addEventListener("input", validateMobile);

        const isReceiving = document.getElementById("IsReceivingSocialBenefit");
            const iecSection = document.getElementById("iecMethodSection");

            const isUsingFP = document.getElementById("IsUsingFamilyPlanning");
            const fpSection = document.getElementById("fpMethodSection");
            const fpNotSection = document.getElementById("fpMethodNotSection");

            const isReferred = document.getElementById("IsReferredForServices");
            const referredSection = document.getElementById("ifreffered");

            function isYes(val) {
                return val === "true" || val === "1";
            }

            function toggleIEC() {
                if (isYes(isReceiving.value)) {
                    iecSection.style.display = "flex";
                } else {
                    iecSection.style.display = "none";
                    document.querySelectorAll("input[name='SocialBenifits']").forEach(cb => cb.checked = false);
                }
            }

            function toggleFP() {
                if (isYes(isUsingFP.value)) {
                    fpSection.style.display = "flex";
                    fpNotSection.style.display = "none";
                    document.getElementById("IsCounsellingDone").value = "";
                }
                else if (isUsingFP.value === "2" || isUsingFP.value === "false") {
                    fpSection.style.display = "none";
                    fpNotSection.style.display = "flex";
                    document.getElementById("FamilyPlanningMethod").value = "";
                }
                else {
                    fpSection.style.display = "none";
                    fpNotSection.style.display = "none";
                }
            }

            function toggleReferred() {
                if (isYes(isReferred.value)) {
                    referredSection.style.display = "block";
                } else {
                    referredSection.style.display = "none";
                    document.getElementById("ReferredHealthCenterType").value = "";
                    document.getElementById("ReferredHealthCenterName").value = "";
                }
            }

            // Run on page load
            toggleIEC();
            toggleFP();
            toggleReferred();

            // Bind change events
            isReceiving.addEventListener("change", toggleIEC);
            isUsingFP.addEventListener("change", toggleFP);
            isReferred.addEventListener("change", toggleReferred);


        });

        //================================Save Visit==============================
            function saveMembers() {

            let form = document.getElementById("linelistForm");
            let btn = document.getElementById("btnSave");
            let btnText = document.getElementById("btnText");
            let btnLoader = document.getElementById("btnLoader");

            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            // Disable button + show loader
            btn.disabled = true;
            btnText.innerText = "Saving...";
            btnLoader.classList.remove("d-none");

            let formData = new FormData(form);

            fetch('@Url.Action("Create", "HomeVisit")', {
                method: "POST",
                body: formData,
                headers: {
                    "RequestVerificationToken":
                        document.querySelector('input[name="__RequestVerificationToken"]').value
                }
            })
            .then(response => response.json())
            .then(data => {

                if (data.success) {

                    Swal.fire({
                        icon: 'success',
                        title: 'Success',
                        text: 'Home Visit saved successfully!',
                        confirmButtonColor: '#3085d6'
                    }).then(() => {
                        window.location.href = '@Url.Action("Index", "HomeVisit")';
                    });

                } else {

                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: data.message || 'Something went wrong'
                    });

                    resetButton();
                }

            })
            .catch(error => {
                console.error(error);

                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'Server error occurred'
                });

                resetButton();
            });

            function resetButton() {
                btn.disabled = false;
                btnText.innerText = "Save";
                btnLoader.classList.add("d-none");
            }
        }

    </script>

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
}
