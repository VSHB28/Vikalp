@using Vikalp.Models.DTO
@model Vikalp.Models.DTO.UserDto
@{
    ViewData["Title"] = "Add User";
    Layout = "~/Views/Shared/_AdminLayout.cshtml";
}

<div class="container py-4">
    <div class="card">
        <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="mb-0">Create User</h5>
                <a href="/User/Index" class="btn btn-secondary">← Back to List</a>
            </div>
            <form action="/User/Create" method="post" class="row g-3">
                @Html.AntiForgeryToken()

                <div class="col-md-3">
                    <label class="form-label">Full name</label>
                    <input name="FullName" value="@Model.FullName" class="form-control" />
                </div>

                <div class="col-md-3">
                    <label class="form-label">Email</label>
                    <input name="Email" value="@Model.Email" class="form-control" />
                </div>

                <div class="col-md-3">
                    <label class="form-label">Mobile</label>
                    <input name="MobileNumber" value="@Model.MobileNumber" class="form-control" maxlength="10" pattern="\d{10}" />
                </div>

                <div class="col-md-3">
                    <label class="form-label">Password</label>
                    <input name="Password" type="password" class="form-control" />
                </div>

                <div class="col-md-3">
                    <label class="form-label">Role</label>
                    <select name="RoleId" class="form-control">
                        <option value="">-- Select Role --</option>
                        @foreach (var r in (IEnumerable<DropdownDto>)ViewBag.Roles)
                        {
                            var selected = Model.RoleId == r.Id ? "selected" : "";
                            <option value="@r.Id" @selected>@r.Name</option>
                        }
                    </select>
                </div>
                <div class="col-md-3">
                    <input type="checkbox"
                           name="IsActive"
                           value="1"
                           @(Model.IsActive == 1 ? "checked" : "") />
                </div>                
               <div class="col-md-3">
                    <label class="form-label">Language</label>

                    <div class="dropdown">
                        <button class="btn btn-outline-secondary dropdown-toggle w-100 text-start"
                                type="button"
                                data-bs-toggle="dropdown">
                            Select Language
                        </button>

                        <ul class="dropdown-menu w-100 p-2" style="max-height:250px; overflow-y:auto;">
                            @foreach (var r in (IEnumerable<DropdownDto>)ViewBag.Languages)
                            {
                                <li>
                                    <div class="form-check">
                                        <input class="form-check-input lang-checkbox"
                                               type="checkbox"
                                               name="LanguageId"
                                               value="@r.Id"
                                               id="lang_@r.Id" />

                                        <label class="form-check-label" for="lang_@r.Id">
                                            @r.Name
                                        </label>
                                    </div>
                                </li>
                            }
                        </ul>
                    </div>
                </div>

                <div class="col-md-3">
                    <label class="form-label">Gender</label>
                    <select name="GenderId" class="form-control">
                        <option value="">-- Select Gender --</option>
                        @foreach (var r in (IEnumerable<DropdownDto>)ViewBag.Genders)
                        {
                            var selected = Model.GenderId == r.Id ? "selected" : "";
                            <option value="@r.Id" @selected>@r.Name</option>
                        }
                    </select>
                </div>

                <hr class="mt-4" />

                <!-- LOCATION MAPPING -->
                <h5>Location Mapping</h5>

                <!-- STATE -->
                <div class="col-md-3">
                    <label class="form-label">State <span class="text-danger">*</span></label>
                    <select id="StateId" name="StateId" class="form-control" required>
                        <option value="">-- Select State --</option>
                        @foreach (var s in (IEnumerable<DropdownDto>)ViewBag.States)
                        {
                            <option value="@s.Id">@s.Name</option>
                        }
                    </select>
                </div>

                <!-- DISTRICT -->
                <div class="col-md-3">
                    <label class="form-label">District <span class="text-danger">*</span></label>
                    <select id="DistrictId" name="DistrictId" class="form-control">
                        <option value="">-- Select District --</option>
                    </select>
                </div>

                <!-- BLOCK -->
                <div class="col-md-3">
                    <label class="form-label">Block</label>
                    <select id="BlockId" name="BlockId" class="form-control">
                        <option value="">-- Select Block --</option>
                    </select>
                </div>

                <div class="col-12">
                    @* <button type="submit" class="btn btn-primary">Create</button> *@
                    <button type="button" class="btn btn-primary" onclick="saveUser()">Create</button>

                    <a href="/User/Index" class="btn btn-secondary ms-2">Cancel</a>
                </div>
            </form>
        </div>
    </div>
</div>
@section Scripts {
    <script>
        document.addEventListener("DOMContentLoaded", function () {

                    document.querySelector("form").addEventListener("submit", function () {

            let ids = Array.from(
                document.querySelectorAll(".lang-checkbox:checked")
            ).map(x => x.value);

            document.getElementById("LanguageId").value = ids.join(",");
        });


            document.getElementById("StateId").addEventListener("change", function () {
                let stateId = this.value;

                reset("DistrictId", "-- Select District --");
                reset("BlockId", "-- Select Block --");
                reset("FacilityId", "-- Select Facility --");

                if (!stateId) return;

                fetch(`/User/GetDistricts?stateId=${stateId}`)
                    .then(r => r.json())
                    .then(data => fill("DistrictId", data));
            });

            document.getElementById("DistrictId").addEventListener("change", function () {
                let districtId = this.value;

                reset("BlockId", "-- Select Block --");
                reset("FacilityId", "-- Select Facility --");

                if (!districtId) return;

                fetch(`/User/GetBlocks?districtId=${districtId}`)
                    .then(r => r.json())
                    .then(data => fill("BlockId", data));
            });

            document.getElementById("BlockId").addEventListener("change", function () {
                let blockId = this.value;

                reset("FacilityId", "-- Select Facility --");

                if (!blockId) return;

                fetch(`/User/GetFacilities?blockId=${blockId}`)
                    .then(r => r.json())
                    .then(data => fill("FacilityId", data));
            });

                    function reset(id, text) {
            let ddl = document.getElementById(id);
            if (!ddl) return;

            ddl.innerHTML = `<option value="">${text}</option>`;
        }


                    function fill(id, data) {
            let ddl = document.getElementById(id);
            if (!ddl) return;

            data.forEach(x => {
                let opt = document.createElement("option");
                opt.value = x.id;
                opt.textContent = x.name;
                ddl.appendChild(opt);
            });
        }            

        });

                function saveUser() {

            // collect language ids
                    let languageIds = Array.from(
            document.querySelectorAll(".lang-checkbox:checked")
        ).map(x => parseInt(x.value));

            let model = {
                FullName: document.querySelector('[name="FullName"]').value || null,
                Email: document.querySelector('[name="Email"]').value || null,
                MobileNumber: document.querySelector('[name="MobileNumber"]').value || null,
                Password: document.querySelector('[name="Password"]').value || null,
                RoleId: document.querySelector('[name="RoleId"]').value || null,
                GenderId: document.querySelector('[name="GenderId"]').value || null,
                IsActive: document.querySelector('[name="IsActive"]')?.checked ? 1 : 0,

                StateId: document.getElementById("StateId").value || null,
                DistrictId: document.getElementById("DistrictId").value || null,
                BlockId: document.getElementById("BlockId").value || null,

                LanguageId: languageIds   // <-- IMPORTANT
            };

            console.log("Posting user:", model);

            fetch('/User/CreateJson', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'RequestVerificationToken':
                        document.querySelector('input[name="__RequestVerificationToken"]').value
                },
                body: JSON.stringify(model)
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    alert("User saved successfully!");
                    window.location.href = "/User/Index";
                } else {
                    alert(data.message || "Save failed");
                }
            })
            .catch(err => {
                console.error(err);
                alert("Error occurred while saving user");
            });
        }

    </script>

}
