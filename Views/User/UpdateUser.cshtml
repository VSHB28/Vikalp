@using Vikalp.Models.DTO
@model Vikalp.Models.DTO.UserDto
@{
    ViewData["Title"] = "Update User";
    Layout = "~/Views/Shared/_AdminLayout.cshtml";
}

<div class="container py-2">
    <div class="card">
        <div class="card-body">
            <div class="umcard-header">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h3 class="mb-0">Edit User</h3>
                </div>
            </div>

            <form action="/User/Edit" method="post" class="row mt-2 g-3">
                @Html.AntiForgeryToken()

                <input type="hidden" name="UserId" value="@Model.UserId" />

                <div class="col-md-3">
                    <label class="form-label">Full name</label>
                    <input name="FullName" value="@Model.FullName" class="form-control" />
                </div>

                <div class="col-md-3">
                    <label class="form-label">Email</label>
                    <input name="Email" value="@Model.Email" class="form-control" />
                </div>

                <div class="col-md-3">
                    <label class="form-label">Mobile</label>
                    <input name="MobileNumber" value="@Model.MobileNumber" class="form-control" maxlength="10" pattern="\d{10}" />
                </div>

                <div class="col-md-3">
                    <label class="form-label">New password</label>
                    <input name="Password" type="password" class="form-control" />
                </div>

                <div class="col-md-3">
                    <label class="form-label">Role</label>
                    <select id ="RoleId" name="RoleId" class="form-control">
                        <option value="">-- Select Role --</option>
                        @foreach (var r in (IEnumerable<DropdownDto>)ViewBag.Roles)
                        {
                            var selected = Model.RoleId == r.Id ? "selected" : "";
                            <option value="@r.Id" @selected>@r.Name</option>
                        }
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Gender</label>
                    <select name="GenderId" class="form-control">
                        <option value="">-- Select Gender --</option>
                        @foreach (var r in (IEnumerable<DropdownDto>)ViewBag.Genders)
                        {
                            var selected = Model.GenderId == r.Id ? "selected" : "";
                            <option value="@r.Id" @selected>@r.Name</option>
                        }
                    </select>
                </div>

                <div class="col-md-3">
                    <label class="form-label">Language</label>

                    <div class="dropdown">
                        <button class="btn form-control dropdown-toggle w-100 text-start"
                                type="button"
                                data-bs-toggle="dropdown">
                            Select Language
                        </button>

                        <ul class="dropdown-menu w-100 p-2" style="max-height:250px; overflow-y:auto;">
                            @foreach (var r in (IEnumerable<DropdownDto>)ViewBag.Languages)
                            {
                                var isChecked = Model.LanguageId != null && Model.LanguageId.Contains(r.Id);

                                <li>
                                    <div class="form-check">
                                        <input class="form-check-input lang-checkbox"
                                               type="checkbox"
                                               value="@r.Id"
                                               id="lang_@r.Id"
                                               @(isChecked ? "checked" : "") />

                                        <label class="form-check-label" for="lang_@r.Id">
                                            @r.Name
                                        </label>
                                    </div>
                                </li>
                            }
                        </ul>
                    </div>

                </div>


                <div class="col-md-3">
                    <label class="form-label d-block">Is Active</label>
                    <input type="checkbox"
                           name="IsActive"
                           value="1"
                           @(Model.IsActive == 1 ? "checked" : "") />
                </div>

                <hr class="mt-4" />

                <!-- LOCATION MAPPING -->
                <h5>Location Mapping</h5>

                <input type="hidden" id="hdnStateId" value="@Model.StateId" />
                <input type="hidden" id="hdnDistrictId"
                       value="@(Model.DistrictIds != null ? string.Join(",", Model.DistrictIds) : "")" />
                <input type="hidden" id="hdnBlockId" value="@Model.BlockId" />

                <!-- STATE -->
                <div class="col-md-3">
                    <label class="form-label">State <span class="text-danger">*</span></label>
                    <select id="StateId" name="StateId" class="form-control" required>
                        <option value="">-- Select State --</option>
                        @foreach (var s in (IEnumerable<DropdownDto>)ViewBag.States)
                        {
                            var selected = Model.StateId == s.Id ? "selected" : "";
                            <option value="@s.Id" @selected>@s.Name</option>
                        }
                    </select>
                </div>


                <!-- DISTRICT MULTISELECT -->
                <div class="col-md-3" id="districtContainer">
                    <label class="form-label">District <span class="text-danger">*</span></label>

                    <div class="dropdown">
                        <button class="btn form-control dropdown-toggle w-100 text-start"
                                type="button"
                                data-bs-toggle="dropdown">
                            Select District
                        </button>

                        <ul class="dropdown-menu w-100 p-2"
                            id="DistrictDropdown"
                            style="max-height:250px; overflow-y:auto;">
                            <!-- districts will be loaded dynamically -->
                        </ul>
                    </div>
                </div>

                <!-- BLOCK -->
                <div class="col-md-3 d-none">
                    <label class="form-label">Block</label>
                    <select id="BlockId" name="BlockId" class="form-control">
                        <option value="">-- Select Block --</option>
                    </select>
                </div>

                <div class="col-12">
                    <button type="button" class="btn-save" onclick="updateuser()">Update</button>
                    <a href="/User/Index" class="btn-back">Cancel</a>
                </div>
            </form>
        </div>
    </div>
</div>
<script>
    document.addEventListener("DOMContentLoaded", function () {

        let stateId = document.getElementById("hdnStateId").value;
        let districtId = document.getElementById("hdnDistrictId").value;
        let blockId = document.getElementById("hdnBlockId").value;

            if (stateId) {
        // convert districtId string into array
        let selectedDistrictIds = districtId
    ? districtId.split(",").map(id => id.trim())
    : [];
    loadDistricts(stateId, selectedDistrictIds);
    }


        document.getElementById("StateId").addEventListener("change", function () {
            let stateId = this.value;
            let roleId = document.getElementById("RoleId").value;

            let ddl = document.getElementById("DistrictDropdown");
            let districtBtn = document.querySelector('[data-bs-toggle="dropdown"]');

            ddl.innerHTML = "";

            // 🚫 If role 1 → do not enable district
            if (roleId === "1") {
                districtBtn.setAttribute("disabled", "disabled");
                return;
            }
            if (!stateId) return;

            fetch(`/User/GetDistricts?stateId=${stateId}`)
                .then(r => r.json())
                .then(data => {
                    data.forEach(d => {
                        ddl.insertAdjacentHTML("beforeend", `
                            <li>
                                <div class="form-check">
                                    <input class="form-check-input district-checkbox"
                                           type="checkbox"
                                           value="${d.id}"
                                           id="dist_${d.id}">
                                    <label class="form-check-label" for="dist_${d.id}">
                                        ${d.name}
                                    </label>
                                </div>
                            </li>
                        `);
                    });
                });
        });

          function loadDistricts(stateId, selectedDistrictIds = []) {
        fetch(`/User/GetDistricts?stateId=${stateId}`)
            .then(r => r.json())
            .then(data => {
                let ddl = document.getElementById("DistrictDropdown");
                if (!ddl) {
                    console.error("DistrictDropdown element not found");
                    return;
                }
                ddl.innerHTML = "";

                data.forEach(x => {
                    let li = document.createElement("li");
                    li.innerHTML = `
                        <div class="form-check">
                            <input class="form-check-input district-checkbox"
                                   type="checkbox"
                                   value="${x.id}"
                                   id="dist_${x.id}"
                                       ${selectedDistrictIds.includes(x.id.toString()) ? "checked" : ""}>
                            <label class="form-check-label" for="dist_${x.id}">
                                ${x.name}
                            </label>
                        </div>
                    `;
                    ddl.appendChild(li);
                });
            });
    }

        let roleId = document.getElementById("RoleId").value;
    let districtContainer = document.getElementById("districtContainer");

    if (roleId === "1") {
        districtContainer.classList.add("d-none");
    } else {
        districtContainer.classList.remove("d-none");
    }

        document.getElementById("RoleId").addEventListener("change", function () {

        let roleId = this.value;
        let districtContainer = document.getElementById("districtContainer");

        if (roleId === "1") {

            // Hide district completely
            districtContainer.classList.add("d-none");

            // Clear selected districts
            document.getElementById("DistrictDropdown").innerHTML = "";

        } else {

            // Show district
            districtContainer.classList.remove("d-none");

            // Reload districts if state already selected
            let stateId = document.getElementById("StateId").value;
            if (stateId) {
                document.getElementById("StateId").dispatchEvent(new Event("change"));
            }
        }
    });

    });

        function updateuser() {
        let languageIds = Array.from(
            document.querySelectorAll(".lang-checkbox:checked")
        ).map(x => parseInt(x.value));

        let districtIds = Array.from(
            document.querySelectorAll(".district-checkbox:checked")
        ).map(x => parseInt(x.value));

        let model = {
            UserId: document.querySelector('[name="UserId"]').value || null,
            FullName: document.querySelector('[name="FullName"]').value || null,
            Email: document.querySelector('[name="Email"]').value || null,
            MobileNumber: document.querySelector('[name="MobileNumber"]').value || null,
            Password: document.querySelector('[name="Password"]').value || null,
            RoleId: document.querySelector('[name="RoleId"]').value || null,
            GenderId: document.querySelector('[name="GenderId"]').value || null,
            IsActive: document.querySelector('[name="IsActive"]')?.checked ? 1 : 0,

            StateId: document.getElementById("StateId").value || null,
            DistrictIds: districtIds,   // now an array
            LanguageId: languageIds
        };

        console.log("Posting user:", model);

        fetch('/User/Edit', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'RequestVerificationToken':
                    document.querySelector('input[name="__RequestVerificationToken"]').value
            },
            body: JSON.stringify(model)
        })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                alert("User Update successfully!");
                window.location.href = "/User/Index";
            } else {
                alert(data.message || "Update failed");
            }
        })
        .catch(err => {
            console.error(err);
            alert("Error occurred while updating user");
        });
    }
</script>
