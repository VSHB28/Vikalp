@model Vikalp.Models.DTO.HealthSystemParticipantDto

@{
    ViewData["Title"] = "Add Participant";
    Layout = "~/Views/Shared/_AdminLayout.cshtml";
}

<style>
    #orientationForm {
        padding: 20px;
        max-width: 1400px;
        margin: 0 auto;
    }

    /* Facility Type Section */
    .form-card {
        background: #fff;
        border-radius: 8px;
        padding: 10px;
        margin-bottom: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .section-title {
        align-items: center;
        gap: 15px;
        margin-bottom: 20px;
        font-size: 18px;
        font-weight: 600;
        color: #333;
    }

        .section-title i {
            font-size: 24px;
            color: #0d6efd;
        }

    .fh-header {
        display: flex;
        gap: 20px;
        margin-left: auto;
    }

    .facility-type-card {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 5px 19px;
        border: 2px solid #dee2e6;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s ease;
        background: #f8f9fa;
    }



        .facility-type-card input[type="radio"] {
            cursor: pointer;
            width: 18px;
            height: 18px;
        }

        .facility-type-card label {
            cursor: pointer;
            margin: 0;
            font-size: 15px;
            font-weight: 500;
        }

    /* Card Header Section */
    .card {
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        margin-bottom: 20px;
    }

    .fh-cardHeader {
        align-items: center;
        justify-content: space-between;
        padding: 10px 0;
    }

        .fh-cardHeader h2 {
            margin: 0;
            font-size: 18px;
            font-weight: 600;
            color: #F15A29;
        }

        .fh-cardHeader .col-md-4 {
            display: flex;
            align-items: center;
            gap: 12px;
        }

            .fh-cardHeader .col-md-4 label {
                white-space: nowrap;
                margin: 0;
                font-weight: 500;
                min-width: 120px;
            }

            .fh-cardHeader .col-md-4 input {
                flex: 1;
            }


    .btn {
        padding: 8px;
        font-weight: 500;
    }

    .btn-success {
        margin: 0;
    }



    /* Hidden utility */
    .d-none {
        display: none !important;
    }

    .fh-section-title {
        align-items: center;
        gap: 15px;
        /* margin-bottom: 20px; */
        font-size: 14px;
        font-weight: 600;
        color: #333;
    }

    .fh-cardBody {
        padding: 1px 10px;
        flex: 1 1 auto;
    }

    .btn-topics {
        height: 32px;
        line-height: 15px;
    }

    .table thead tr th, .table tbody tr th {
        vertical-align: middle;
    }

    .fh-modal-header {
        color: #F15A29;
    }
</style>

<form asp-action="Create" method="post" id="orientationForm">
    @Html.AntiForgeryToken()

    <div class="form-card">
        <div class="fh-section-title d-flex">
            <i class="bi bi-gear"></i>
            Select Facility Type

            <div class="fh-header">
                <div class="facility-type-card" id="interventionCard">
                    <input class="form-check-input"
                           type="radio"
                           id="intervention"
                           value="1"
                           name="InterventionFacility"
                           onchange="handleFacilityTypeChange()"
                           checked />

                    <label class="form-check-label" for="intervention">Intervention</label>
                </div>
                <div class="facility-type-card" id="nonInterventionCard">
                    <input class="form-check-input"
                           type="radio"
                           id="nonIntervention"
                           value="0"
                           name="InterventionFacility"
                           onchange="handleFacilityTypeChange()" />

                    <label class="form-check-label" for="nonIntervention">Non-Intervention</label>
                </div>
            </div>
        </div>
    </div>
    <div class="card">
        <div class="fh-cardBody">
            <div class="fh-cardHeader d-flex gap-5">
                <h2>Add Participant</h2>
                @{
                    var today = DateTime.Today;
                    var minDate = today.AddDays(-5).ToString("yyyy-MM-dd");
                    var maxDate = today.ToString("yyyy-MM-dd");
                }
                <div class="col-md-4 d-flex">
                    <label>Activity Date</label>
                    <input name="DateofActivity" type="date" class="form-control" min="@minDate" max="@maxDate" />
                    <span asp-validation-for="DateofOrientation" class="text-danger"></span>

                </div>
            </div>
        </div>
    </div>
    <div class="row">
        <div class="col-md-2">
            <label>State</label>
            <select name="StateId" class="form-control" id="StateId">
                <option value="">-- Select State --</option>
                @foreach (var s in ViewBag.States)
                {
                    <option value="@s.Id" @(Model.StateId == s.Id ? "selected" : "")>@s.Name</option>
                }
            </select>
        </div>
        <div class="col-md-2">
            <label>District</label>
            <select name="DistrictId" class="form-control" id="DistrictId">
                <option value="">-- Select District --</option>
            </select>
        </div>

        <div class="col-md-2">
            <label>Block</label>
            <select name="BlockId" class="form-control" id="BlockId">
                <option value="">-- Select Block --</option>
            </select>
        </div>

        <div class="col-md-2">
            <label>Facility Type</label>
            <select name="FacilityTypeId" class="form-control" id="FacilityTypeId">
                <option value="">-- Select Facility Type --</option>
                @foreach (var s in (IEnumerable<SelectListItem>)ViewBag.FacilityType)
                {
                    <option value="@s.Value" @(Model.FacilityTypeId.ToString() == s.Value ? "selected" : "")>
                        @s.Text
                    </option>
                }
            </select>
        </div>

        <div class="col-md-2" id="otherfacilityDiv">
            <label>Facility Type Other</label>
            <input name="FacilityTypeOther" class="form-control" id="FacilityTypeOther" />
        </div>

        <div class="col-md-2" id="facilityDropdownDiv">
            <label>Facility</label>
            <select name="FacilityId" class="form-control" id="FacilityId">
                <option value="">-- Select Facility --</option>
            </select>
        </div>
        <div class="col-md-2 d-none" id="manualFacilityDiv">
            <label>Facility</label>
            <input name="FacilityName" class="form-control" placeholder="Enter Facility name" />
        </div>
        <div class="col-md-2">
            <label>Facility NIN</label>
            <input name="NIN" id="NinNumber" class="form-control" placeholder="Enter NIN" />
        </div>

        <div class="col-md-2">
            <label>Provider Type</label>
            <select name="ProviderTypeId" class="form-control" id="ProviderTypeId">
                <option value="">-- Select --</option>
                @foreach (var s in (IEnumerable<SelectListItem>)ViewBag.ProviderType)
                {
                    <option value="@s.Value" @(Model.ProviderTypeId.ToString() == s.Value ? "selected" : "")>
                        @s.Text
                    </option>
                }
            </select>
        </div>
        <div class="col-md-2">
            <label>Activity</label>
            <select name="ActivityNameId" class="form-control" id="ActivityNameId">
                <option value="">-- Select --</option>
                @foreach (var s in (IEnumerable<SelectListItem>)ViewBag.ActivityTypeName)
                {
                    <option value="@s.Value" @(Model.ActivityNameId.ToString() == s.Value ? "selected" : "")>
                        @s.Text
                    </option>
                }
            </select>
        </div>
        <div class="col-md-2">
            <label>Remarks</label>
            <textarea name="Remarks" class="form-control"></textarea>
        </div>
    </div>

    <div class="modal fade" id="participantModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title fh-modal-header">Add Participant</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>

                <div class="modal-body">
                    <div class="mb-3">
                        <label>Facility Type <span class="text-danger">*</span></label>
                        <select id="modalFacilityType" class="form-control">
                            <option value="">-- Select --</option>
                            <option value="intervention">Intervention</option>
                            <option value="non-intervention">Non-Intervention</option>
                        </select>
                    </div>
                    <div class="mb-3" id="modalFacilityDiv">
                        <label>Facility</label>
                        <input type="text" id="facilitySearch" class="form-control" placeholder="Search facility..." />
                        <input type="hidden" id="selectedFacilityId" />
                        <div id="facilityResults" class="list-group"></div>
                    </div>
                    <div class="mb-3" id="modalparticipantDiv">
                        <label>Select Participant</label>

                        <div class="border rounded p-2" style="max-height:300px; overflow-y:auto;">
                            <table class="table table table-bordered mb-0">
                                <thead>
                                    <tr>
                                        <th>Select</th>
                                        <th>Participant</th>
                                        <th>Mobile</th>
                                        <th>Facility</th>
                                    </tr>
                                </thead>
                                <tbody id="participantBody">
                                    <!-- Participant loaded dynamically -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div class="mb-3 d-none" id="modalfacilityTextDiv">
                        <label>Facility Name</label>
                        <input type="text" id="modalfacilityText" class="form-control" placeholder="Enter Facility name" />
                    </div>

                    <div class="mb-3 d-none" id="modalParticipantTextDiv">
                        <label>Full Name</label>
                        <input type="text" id="modalParticipantText" class="form-control" placeholder="Enter Participant name" />
                    </div>

                    <div class="mb-3 d-none" id="modalgenderdiv">
                        <label>Gender</label>
                        <select name="GenderId" class="form-control" id="GenderId">
                            <option value="">-- Select Gender --</option>
                            @foreach (var s in ViewBag.Genders)
                            {
                                <option value="@s.Id" @(Model.GenderId == s.Id ? "selected" : "")>@s.Name</option>
                            }
                        </select>
                    </div>

                    <div class="mb-3 d-none" id="modalParticipantMobDiv">
                        <label>Mobile Number</label>
                        <input type="text" id="modelMobNumber" class="form-control" maxlength="10" pattern="\d{10}" placeholder="Enter Mobile Number" />
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" id="modalOkBtn">OK</button>
                </div>
            </div>
        </div>
    </div>

    <table class="table table-bordered mt-2" id="participantTable">
        <thead>
            <tr>
                <th>#</th>
                <th>Facility</th>
                <th>Full Name</th>
                <th>Mobile</th>
                <th>VCAT Pre</th>
                <th>VCAT Post</th>
                <th>RefresherTraining</th>
                <th>
                    <button type="button" class="btn btn-success px-2 py-1" id="addRowBtn">
                        + Participant
                    </button>
                </th>
            </tr>
        </thead>
        <tbody id="participantRows"></tbody>
    </table>
    <hr />

    <button type="button" class="btn-save" onclick="saveParticipants()">Save</button>
    <a href="@Url.Action("Index", "HealthSystemParticipant")" class="btn-back">Back</a>


</form>


<script type="text/template" id="participantRowTemplate">
    <tr>
        <td class="slno"></td>
        <td>
            <span class="facilityName"></span>
            <input type="hidden" name="Participants[__index__].FacilityId" class="hdFacilityId" />
            <input type="hidden" name="Participants[__index__].FacilityName" class="hdFacilityName" />
        </td>
        <td>
        <span class="fullName"></span>
            <input type="hidden" name="Participants[__index__].FullName" class="hdFullName" />
            </td>
        <td>
           <span class="mobile"></span>
            <input type="hidden" name="Participants[__index__].Mobile" class="hdMobile" />
        </td>
         <td>
                <input name="Participants[__index__].VCATScorePreTest" type="number" min="0" max="99" class="form-control" />
            </td>

            <td>
                <input name="Participants[__index__].VCATScorePostTest" type="number" min="0" max="99" class="form-control" />
            </td>

        <td class="text-center">
             <!-- unchecked -->
             <input type="hidden" name="Participants[__index__].RefresherTraining" value="0" />

             <!-- checked -->
             <input type="checkbox" name="Participants[__index__].RefresherTraining" value="1" />


            <input type="hidden" name="Participants[__index__].GenderId" class="hdGenderId" />
            <input type="hidden" name="Participants[__index__].ProviderTypeId" class="hdProviderTypeId" />
            <input type="hidden" name="Participants[__index__].ActivityNameId" class="hdActivityNameId" />
            <input type="hidden" name="Participants[__index__].FacilityTypeId" class="hdFacilityTypeId" />
            <input type="hidden" name="Participants[__index__].FacilityTypeOther" class="hdFacilityTypeOther" />
            <input type="hidden" name="Participants[__index__].InterventionFacility" class="hdInterventionFacility" />
            <input type="hidden" name="Participants[__index__].DistrictId" class="hdDistrictId" />
            <input type="hidden" name="Participants[__index__].StateId" class="hdStateId" />
        </td>

        <td>
            <button type="button" class="btn btn-sm btn-danger removeRow">Remove</button>
        </td>
    </tr>
</script>


@section Scripts {
    <script>

        // ---------------- FACILITY TYPE TOGGLE ----------------
        function handleFacilityTypeChange() {
            let isIntervention = document.getElementById("intervention").checked;
            let facilityDropdown = document.getElementById("facilityDropdownDiv");
            let manualFacility = document.getElementById("manualFacilityDiv");

            if (isIntervention) {
                facilityDropdown.classList.remove("d-none");
                manualFacility.classList.add("d-none");
            } else {
                facilityDropdown.classList.add("d-none");
                manualFacility.classList.remove("d-none");
            }
        }

        document.addEventListener("DOMContentLoaded", function () {
            handleFacilityTypeChange();
        });


                let participantIndex = 0;

        document.addEventListener("DOMContentLoaded", function () {

            document.getElementById("modalOkBtn").addEventListener("click", function () {

                const facilityType = document.getElementById("modalFacilityType").value;

                let fullName = "";
                let mobile = "";
                let facilityId = "";
                let facilityName = "";

                if (facilityType === "intervention") {
                    const selected = document.querySelector('input[name="participantSelect"]:checked');
                    if (!selected) {
                        alert("Please select participant");
                        return;
                    }

                    fullName = selected.dataset.name;
                    mobile = selected.dataset.mobile;
                    facilityId = selected.dataset.facilityid;
                    facilityName = selected.dataset.facilityname;

                } else if (facilityType === "non-intervention") {
                    fullName = document.getElementById("modalParticipantText").value.trim();
                    mobile = document.getElementById("modelMobNumber").value.trim();
                    facilityName = document.getElementById("modalfacilityText").value.trim();

                    if (!fullName) {
                        alert("Please enter participant name");
                        return;
                    }
                } else {
                    alert("Please select Facility Type");
                    return;
                }

                const genderSelect = document.getElementById("GenderId");
                const genderId = genderSelect.value;
                const stateId = document.getElementById("StateId").value;
                const districtId = document.getElementById("DistrictId").value;
                const providerTypeId = document.getElementById("ProviderTypeId").value;
                const activityNameId = document.getElementById("ActivityNameId").value;
                const facilityTypeId = document.getElementById("FacilityTypeId").value;
                const facilityTypeOther = document.querySelector('[name="FacilityTypeOther"]').value;

                // Create row
                let template = document.getElementById("participantRowTemplate").innerHTML;
                template = template.replace(/__index__/g, participantIndex);

                const tempDiv = document.createElement("tbody");
                tempDiv.innerHTML = template.trim();
                const row = tempDiv.firstElementChild;
                row.querySelector(".hdStateId").value = stateId;
                row.querySelector(".hdDistrictId").value = districtId;
                row.querySelector(".hdProviderTypeId").value = providerTypeId;
                row.querySelector(".hdActivityNameId").value = activityNameId;
                row.querySelector(".hdFacilityTypeId").value = facilityTypeId;
                row.querySelector(".hdFacilityTypeOther").value = facilityTypeOther;

                row.querySelector(".fullName").textContent = fullName;
                row.querySelector(".facilityName").textContent = facilityName;
                row.querySelector(".mobile").textContent = mobile;

                row.querySelector(".hdFullName").value = fullName;
                row.querySelector(".hdMobile").value = mobile;
                row.querySelector(".hdFacilityId").value = facilityId;
                row.querySelector(".hdFacilityName").value = facilityName;
                row.querySelector(".hdGenderId").value = genderId;
                row.querySelector(".hdInterventionFacility").value =
                    facilityType === "intervention" ? 1 : 0;

                document.querySelector("#participantTable tbody").appendChild(row);

                participantIndex++;
                updateSlNo();

                bootstrap.Modal.getInstance(
                    document.getElementById("participantModal")
                ).hide();
            });
        });

        // Remove row
        document.addEventListener("click", function (e) {
            if (e.target.classList.contains("removeRow")) {
                e.target.closest("tr").remove();
            }
        });


        // ---------------- OPEN MODAL ----------------
                        document.addEventListener("DOMContentLoaded", function () {
            document.getElementById("addRowBtn").addEventListener("click", function () {
                resetParticipantModal();
                let modal = new bootstrap.Modal(
                    document.getElementById("participantModal")
                );
                modal.show();
            });
        });

        //====================intervention change===========================

                       document.addEventListener("DOMContentLoaded", function () {

            const facilityType = document.getElementById("modalFacilityType");

            const participantDiv = document.getElementById("modalparticipantDiv");
            const facilityDiv = document.getElementById("modalFacilityDiv");
            const facilityTextDiv = document.getElementById("modalfacilityTextDiv");
            const participantTextDiv = document.getElementById("modalParticipantTextDiv");
            const participantMobDiv = document.getElementById("modalParticipantMobDiv");
            const genderMobDiv = document.getElementById("modalgenderdiv");

            facilityType.addEventListener("change", function () {

                // Hide all first
                participantDiv.classList.add("d-none");
                facilityDiv.classList.add("d-none");
                facilityTextDiv.classList.add("d-none");
                participantTextDiv.classList.add("d-none");
                participantMobDiv.classList.add("d-none");
                genderMobDiv.classList.add("d-none")

                // Intervention
                if (this.value === "intervention") {
                    participantDiv.classList.remove("d-none");
                    facilityDiv.classList.remove("d-none");
                }

                // Non-intervention
                if (this.value === "non-intervention") {
                    facilityTextDiv.classList.remove("d-none");
                    participantTextDiv.classList.remove("d-none");
                    participantMobDiv.classList.remove("d-none");
                    genderMobDiv.classList.remove("d-none")
                }
            });
        });

        // ---------------- REMOVE ROW ----------------
        document.addEventListener("click", function (e) {
            if (e.target.classList.contains("removeRow")) {
                e.target.closest("tr").remove();
                updateRowNumbers();
            }
        });

        function updateRowNumbers() {
            document.querySelectorAll("#ashaRows tr").forEach((row, i) => {
                row.querySelector(".rowIndex").innerText = i + 1;
            });
        }


                function updateSlNo() {
            document
                .querySelectorAll("#participantTable tbody tr")
                .forEach((row, index) => {
                    row.querySelector(".slno").textContent = index + 1;
                });
        }


        //====================by default popup====================
                document.addEventListener("DOMContentLoaded", function () {

            const participantDiv = document.getElementById("modalparticipantDiv");
            const facilityDiv = document.getElementById("modalFacilityDiv");
            const facilityTextDiv = document.getElementById("modalfacilityTextDiv");
            const participantTextDiv = document.getElementById("modalParticipantTextDiv");
            const participantMobDiv = document.getElementById("modalParticipantMobDiv");
            const genderMobDiv = document.getElementById("modalgenderdiv");

            function resetModalView() {
                participantDiv.classList.add("d-none");
                facilityDiv.classList.add("d-none");
                facilityTextDiv.classList.add("d-none");
                participantTextDiv.classList.add("d-none");
                participantMobDiv.classList.add("d-none");
                genderMobDiv.classList.add("d-none");
            }

            // When modal opens
            const modalEl = document.getElementById("participantModal");
            modalEl.addEventListener("shown.bs.modal", function () {
                document.getElementById("modalFacilityType").value = "";
                resetModalView();
            });

        });


        // ---------------- FACILITY SEARCH (DEBOUNCE) ----------------
        let typingTimer;
        let doneTypingInterval = 1200;

        document.getElementById("facilitySearch").addEventListener("keyup", function () {
            clearTimeout(typingTimer);
            let term = this.value;

            if (term.length < 1) return;

            typingTimer = setTimeout(function () {
                searchFacilities(term);
            }, doneTypingInterval);
        });

        function searchFacilities(term) {
            fetch(`/HealthSystemParticipant/SearchFacilities?term=${term}`)
                .then(res => res.json())
                .then(data => {
                    let list = document.getElementById("facilityResults");
                    list.innerHTML = "";

                    data.forEach(x => {
                        let item = document.createElement("a");
                        item.className = "list-group-item list-group-item-action";
                        item.textContent = x.name;
                        item.onclick = function () {
                            selectFacility(x.id, x.name);
                        };
                        list.appendChild(item);
                    });
                });
        }

        function selectFacility(id, name) {
            document.getElementById("facilitySearch").value = name;
            document.getElementById("selectedFacilityId").value = id;
            document.getElementById("facilityResults").innerHTML = "";
            loadParticipantsByFacility(id);
        }

                function loadParticipantsByFacility(facilityId) {
            fetch(`/HealthSystemParticipant/GetParticipantByFacility?facilityId=${facilityId}`)
                .then(res => res.json())
                .then(data => {

                    const tbody = document.getElementById("participantBody");
                    tbody.innerHTML = "";

                    data.forEach(x => {

                        const row = document.createElement("tr");

                        row.innerHTML = `
                            <td class="text-center">
                                <input type="radio"
                                       name="participantSelect"
                                       data-name="${x.fullName}"
                                       data-facilityid="${x.facilityId}"
                                       data-mobile="${x.mobile || ''}"
                                       data-facilityname="${x.facilityName || ''}"
                            </td>
                            <td>${x.fullName}</td>
                            <td>${x.mobile || '-'}</td>
                            <td>${x.facilityName || '-'}</td>
                        `;

                        tbody.appendChild(row);
                    });
                })
                .catch(err => {
                    console.error("Error loading participants", err);
                });
        }


            function resetParticipantModal() {

            // Reset dropdown
            const facilityType = document.getElementById("modalFacilityType");
            if (facilityType) facilityType.value = "";

            // Clear facility search
            const facilitySearch = document.getElementById("facilitySearch");
            if (facilitySearch) facilitySearch.value = "";

            const selectedFacilityId = document.getElementById("selectedFacilityId");
            if (selectedFacilityId) selectedFacilityId.value = "";

            // Clear dynamic lists
            const facilityResults = document.getElementById("facilityResults");
            if (facilityResults) facilityResults.innerHTML = "";

            const participantBody = document.getElementById("participantBody");
            if (participantBody) participantBody.innerHTML = "";

            // Clear manual entry fields
            const modalFacilityText = document.getElementById("modalfacilityText");
            if (modalFacilityText) modalFacilityText.value = "";

            const modalParticipantText = document.getElementById("modalParticipantText");
            if (modalParticipantText) modalParticipantText.value = "";

            const modalMobile = document.getElementById("modelMobNumber");
            if (modalMobile) modalMobile.value = "";

            // Reset gender
            const genderSelect = document.getElementById("GenderId");
            if (genderSelect) genderSelect.value = "";

            // Hide all conditional sections
            document.getElementById("modalFacilityDiv")?.classList.add("d-none");
            document.getElementById("modalparticipantDiv")?.classList.add("d-none");
            document.getElementById("modalfacilityTextDiv")?.classList.add("d-none");
            document.getElementById("modalParticipantTextDiv")?.classList.add("d-none");
            document.getElementById("modalParticipantMobDiv")?.classList.add("d-none");
            document.getElementById("modalgenderdiv")?.classList.add("d-none");
        }


        // ---------------- CASCADING DROPDOWNS ----------------

        document.getElementById("StateId").addEventListener("change", function () {
            let stateId = this.value;
            resetDropdown("DistrictId", "-- Select District --");
            resetDropdown("BlockId", "-- Select Block --");
            resetDropdown("FacilityId", "-- Select Facility --");

            if (!stateId) return;

            fetch(`/HealthSystemParticipant/GetDistricts?stateId=${stateId}`)
                .then(res => res.json())
                .then(data => {
                    fillDropdown("DistrictId", data, "id", "name");
                });
        });

        document.getElementById("DistrictId").addEventListener("change", function () {
            let districtId = this.value;
            resetDropdown("BlockId", "-- Select Block --");
            resetDropdown("FacilityId", "-- Select Facility --");

            if (!districtId) return;

            fetch(`/HealthSystemParticipant/GetBlocks?districtId=${districtId}`)
                .then(res => res.json())
                .then(data => {
                    fillDropdown("BlockId", data, "id", "name");
                });
        });

        document.getElementById("BlockId").addEventListener("change", function () {
            let blockId = this.value;
            resetDropdown("FacilityId", "-- Select Facility --");

            if (!blockId) return;

            fetch(`/HealthSystemParticipant/GetFacilities?blockId=${blockId}`)
                .then(res => res.json())
                .then(data => {
                    fillDropdown("FacilityId", data, "id", "name");
                });
        });

               document.getElementById("FacilityId").addEventListener("change", function () {
            let facilityId = this.value;

            if (!facilityId) {
                document.getElementById("NinNumber").value = "";
                return;
            }

            fetch(`/HealthSystemParticipant/GetFacilityById?facilityId=${facilityId}`)
                .then(res => res.json())
                .then(data => {
                    if (data) {
                        document.getElementById("NinNumber").value = data.ninNumber || "";
                    }
                });
        });

        function resetDropdown(id, placeholder) {
            let ddl = document.getElementById(id);
            ddl.innerHTML = `<option value="">${placeholder}</option>`;
        }

        function fillDropdown(id, data, valueField, textField) {
            let ddl = document.getElementById(id);
            data.forEach(x => {
                let opt = document.createElement("option");
                opt.value = x[valueField];
                opt.text = x[textField];
                ddl.appendChild(opt);
            });
        }

                const activityNameSelect = document.getElementById("FacilityTypeId");
        const otherDiv = document.getElementById("otherfacilityDiv");
        const otherInput = document.getElementById("FacilityTypeOther");

        const OTHER_FACILITY_ID = "8"; // keep as string (select values are strings)

        function toggleOtherActivity() {
            const selectedValue = activityNameSelect.value;

            if (selectedValue === OTHER_FACILITY_ID) {
                otherDiv.style.display = "block";
                otherInput.disabled = false;
            } else {
                otherDiv.style.display = "none";
                otherInput.value = "";
                otherInput.disabled = true;
            }
        }

        activityNameSelect.addEventListener("change", toggleOtherActivity);

        // Optional: run once on page load (edit mode)
        toggleOtherActivity();


            function saveParticipants() {

            let participants = [];

            document.querySelectorAll("#participantTable tbody tr").forEach(row => {

                let participant = {
                    FullName: row.querySelector(".hdFullName")?.value || null,
                    Mobile: row.querySelector(".hdMobile")?.value || null,
                    FacilityId: row.querySelector(".hdFacilityId")?.value || null,
                    FacilityName: row.querySelector(".hdFacilityName")?.value || null,
                    GenderId: row.querySelector(".hdGenderId")?.value || null,
                    ProviderTypeId: row.querySelector(".hdProviderTypeId")?.value || null,
                    ActivityNameId: row.querySelector(".hdActivityNameId")?.value || null,
                    FacilityTypeId: row.querySelector(".hdFacilityTypeId")?.value || null,
                    FacilityTypeOther: row.querySelector(".hdFacilityTypeOther")?.value || null,
                    InterventionFacility: row.querySelector(".hdInterventionFacility")?.value || null,
                    DistrictId: row.querySelector(".hdDistrictId")?.value || null,
                    StateId: row.querySelector(".hdStateId")?.value || null,

                    VCATScorePreTest:
                        row.querySelector('[name*="VCATScorePreTest"]')?.value || null,

                    VCATScorePostTest:
                        row.querySelector('[name*="VCATScorePostTest"]')?.value || null,

                    RefresherTraining:
                        row.querySelector('[type="checkbox"]')?.checked ? 1 : 0
                };

                participants.push(participant);
            });

            if (participants.length === 0) {
                alert("Please add at least one participant");
                return;
            }

            let model = {
                DateofActivity: document.querySelector('[name="DateofActivity"]').value,
                StateId: document.getElementById("StateId").value,
                DistrictId: document.getElementById("DistrictId").value,
                FacilityTypeId: document.getElementById("FacilityTypeId").value || null,
                FacilityTypeOther: document.getElementById("FacilityTypeOther").value || null,
                Participants: participants
            };

            fetch('/HealthSystemParticipant/SaveParticipantsJson', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'RequestVerificationToken':
                        document.querySelector('input[name="__RequestVerificationToken"]').value
                },
                body: JSON.stringify(model)
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    alert("Saved successfully!");
                    window.location.href = "/HealthSystemParticipant/Index";
                } else {
                    alert(data.message || "Save failed");
                }
            })
            .catch(err => {
                console.error(err);
                alert("Error occurred while saving");
            });
        }


    </script>
}