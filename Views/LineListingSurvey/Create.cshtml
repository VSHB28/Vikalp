@model Vikalp.Models.DTO.LineListingSurveyDto

@{
    ViewData["Title"] = "Add Line List";
    Layout = "~/Views/Shared/_AdminLayout.cshtml";
}

<style>
    #linelistForm {
        padding: 20px;
        max-width: 1400px;
        margin: 0 auto;
    }

    /* Facility Type Section */
    .form-card {
        background: #fff;
        border-radius: 8px;
        padding: 10px;
        margin-bottom: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .section-title {
        align-items: center;
        gap: 15px;
        margin-bottom: 20px;
        font-size: 18px;
        font-weight: 600;
        color: #333;
    }

        .section-title i {
            font-size: 24px;
            color: #0d6efd;
        }

    .fh-header {
        display: flex;
        gap: 20px;
        margin-left: auto;
    }

    .facility-type-card {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 5px 19px;
        border: 2px solid #dee2e6;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s ease;
        background: #f8f9fa;
    }



        .facility-type-card input[type="radio"] {
            cursor: pointer;
            width: 18px;
            height: 18px;
        }

        .facility-type-card label {
            cursor: pointer;
            margin: 0;
            font-size: 15px;
            font-weight: 500;
        }

    /* Card Header Section */
    .card {
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        margin-bottom: 20px;
    }

    .fh-cardHeader {
        align-items: center;
        justify-content: space-between;
        padding: 10px 0;
    }

        .fh-cardHeader h2 {
            margin: 0;
            font-size: 18px;
            font-weight: 600;
            color: #F15A29;
        }

        .fh-cardHeader .col-md-4 {
            display: flex;
            align-items: center;
            gap: 12px;
        }

            .fh-cardHeader .col-md-4 label {
                white-space: nowrap;
                margin: 0;
                font-weight: 500;
                min-width: 120px;
            }

            .fh-cardHeader .col-md-4 input {
                flex: 1;
            }


    .btn {
        padding: 8px;
        font-weight: 500;
    }

    .btn-success {
        margin: 0;
    }



    /* Hidden utility */
    .d-none {
        display: none !important;
    }

    .fh-section-title {
        align-items: center;
        gap: 15px;
        /* margin-bottom: 20px; */
        font-size: 14px;
        font-weight: 600;
        color: #333;
    }

    .fh-cardBody {
        padding: 1px 10px;
        flex: 1 1 auto;
    }

    .btn-topics {
        height: 32px;
        line-height: 15px;
    }

    .table thead tr th, .table tbody tr th {
        vertical-align: middle;
    }

    .fh-modal-header {
        color: #F15A29;
    }
</style>

<style>
    :root {
        --all-ipas-primary: #F15A29;
        --all-ipas-light: #F8F6F3;
        --all-ipas-text-dark: #2C2C2C;
        --all-ipas-text-muted: #666666;
        --all-ipas-white: #FFFFFF;
        --all-border-soft: #F3D2B8;
    }

    * {
        box-sizing: border-box;
    }

   

    .all-modal-shell {
        background: transparent;
        padding: 24px;
        width: 100%;
        max-width: 960px;
    }

    .all-modal-container {
        background-color: var(--all-ipas-white);
        border-radius: 10px;
        box-shadow: 0 18px 40px rgba(0,0,0,0.25);
        overflow: hidden;
        display: flex;
        flex-direction: column;
    }

    .all-modal-header {
        background-color: #FBD9A5;
        color: var(--all-ipas-text-dark);
        padding: 18px 24px;
        display: flex;
        align-items: center;
        justify-content: space-between;
    }

        .all-modal-header h2 {
            margin: 0;
            font-size: 20px;
            font-weight: 600;
        }

    .all-close-btn {
        border: none;
        background: transparent;
        font-size: 22px;
        line-height: 1;
        cursor: pointer;
        color: #b08968;
    }

    .all-modal-body {
        padding: 20px 24px 24px;
        background-color: var(--all-ipas-light);
    }

    .all-section-wrapper {
        display: grid;
        grid-template-columns: 1fr;
        gap: 18px;
    }

    .all-section-card {
        background: var(--all-ipas-white);
        border-radius: 8px;
        border: 1px solid #F0E0D2;
        padding: 14px 16px 16px;
    }

    .all-section-header {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 10px;
    }

    .all-section-icon {
        width: 28px;
        height: 28px;
        border-radius: 999px;
        background: rgba(241, 90, 41, 0.08);
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--all-ipas-primary);
        font-size: 15px;
    }

    .all-section-title {
        font-size: 13px;
        font-weight: 600;
        color: var(--all-ipas-text-dark);
        text-transform: uppercase;
        letter-spacing: 0.06em;
    }

    .all-section-subtitle {
        font-size: 11px;
        color: var(--all-ipas-text-muted);
        margin-top: 2px;
    }

    .all-form-grid {
        display: grid;
        grid-template-columns: repeat(3, minmax(0, 1fr));
        gap: 12px 14px;
    }

    .all-form-grid-2 {
        grid-template-columns: repeat(2, minmax(0, 1fr));
    }

    .all-form-group {
        display: flex;
        flex-direction: column;
    }

    .all-form-label {
        font-size: 12px;
        font-weight: 500;
        color: var(--all-ipas-text-dark);
        margin-bottom: 4px;
        display: flex;
        align-items: center;
        gap: 6px;
    }

    .all-label-icon {
        color: var(--all-ipas-primary);
        font-size: 14px;
    }

    .all-form-input,
    .all-form-select,
    .all-form-textarea {
        padding: 10px 12px;
        border-radius: 6px;
        border: 1px solid var(--all-border-soft);
        font-size: 14px;
        font-family: inherit;
        outline: none;
    }

    .all-form-textarea {
        min-height: 70px;
        resize: vertical;
    }

        .all-form-input:focus,
        .all-form-select:focus,
        .all-form-textarea:focus {
            border-color: var(--all-ipas-primary);
            box-shadow: 0 0 0 2px rgba(241,90,41,0.18);
        }

    .all-modal-footer {
        padding: 14px 24px 18px;
        background-color: #FBD9A5;
        display: flex;
        justify-content: flex-end;
    }

    .all-btn-add {
        min-width: 130px;
        padding: 10px 26px;
        border-radius: 4px;
        border: 1px solid #f1a259;
        font-weight: 600;
        font-size: 14px;
        cursor: pointer;
        letter-spacing: 0.5px;
        background-color: #FFD8A6;
        color: #e46b29;
    }

        .all-btn-add:hover {
            background-color: #ffc37a;
        }

    @@media (max-width: 900px) {
        .all-form-grid,
        .all-form-grid-2 {
            grid-template-columns: repeat(2, minmax(0, 1fr));
        }
    }

    @@media (max-width: 640px) {
        .all-modal-shell {
            padding: 12px;
        }

        .all-form-grid,
        .all-form-grid-2 {
            grid-template-columns: 1fr;
        }
    }
</style>

<form asp-action="Create" method="post" id="linelistForm">
    @Html.AntiForgeryToken()

    <div class="card">
        <div class="fh-cardBody">
            <div class="fh-cardHeader d-flex gap-5">
                <h2 class="mb-3">Add Member</h2>
                @{
                    var today = DateTime.Today;
                    var minDate = today.AddDays(-5).ToString("yyyy-MM-dd");
                    var maxDate = today.ToString("yyyy-MM-dd");
                }
                <div class="col-md-4 d-flex">
                    <label>Line Listing Date</label>
                    <input name="CreatedOn" type="date" class="form-control" min="@minDate" max="@maxDate" />
                    <span asp-validation-for="CreatedOn" class="text-danger"></span>

                </div>
            </div>
        </div>
    </div>
    <div class="row g-2">
        <div class="col-md-2">
            <label>State</label>
            <select name="StateId" class="form-control" id="StateId">
                <option value="">-- Select State --</option>
                @foreach (var s in ViewBag.States)
                {
                    <option value="@s.Id" @(Model.StateId == s.Id ? "selected" : "")>@s.Name</option>
                }
            </select>
        </div>
        <div class="col-md-2">
            <label>District</label>
            <select name="DistrictId" class="form-control" id="DistrictId">
                <option value="">-- Select District --</option>
            </select>
        </div>

        <div class="col-md-2">
            <label>Block</label>
            <select name="BlockId" class="form-control" id="BlockId">
                <option value="">-- Select Block --</option>
            </select>
        </div>

        <div class="col-md-2">
            <label>Facility</label>
            <select name="FacilityId" class="form-control" id="FacilityId">
                <option value="">-- Select Facility --</option>
            </select>
        </div>

        <div class="col-md-2">
            <label>Sub Centre</label>
            <select name="SubCenterId" class="form-control" id="SubCenterId">
                <option value="">-- Select Sub-centre --</option>
            </select>
        </div>

        <div class="col-md-2">
            <label>ASHA Name</label>
            <select name="AshaId" class="form-control" id="AshaId">
                <option value="">-- Select ASHA --</option>
            </select>
        </div>

        <div class="col-md-2">
            <label>Anganwadi Worker</label>
            <input type="text" name="AnganwadiWorkerName" class="form-control" placeholder="Enter AWC name" />
        </div>

        <div class="col-md-2">
            <label>Village Name</label>
            <input type="text" name="VillageName" class="form-control" placeholder="Enter Village name" />
        </div>

    </div>
    <div class="modal fade" id="memberModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content all-modal-container">
                <div class="all-modal-header">
                    <h2>Add Line Listing Member</h2>
                    <button class="all-close-btn" aria-label="Close">&times;</button>
                </div>

                <div class="all-modal-body">
                    <div>
                        <div class="all-section-wrapper">

                            <!-- Woman & Husband Details -->
                            <div class="all-section-card">
                                <div class="all-section-header">
                                    <div class="all-section-icon"><i class="bi bi-person-vcard"></i></div>
                                    <div>
                                        <div class="all-section-title">Woman & Husband Details</div>
                                        <div class="all-section-subtitle">Basic identification information</div>
                                    </div>
                                </div>
                                <div class="all-form-grid all-form-grid-2">
                                    <div class="all-form-group">
                                        <label class="all-form-label"><i class="bi bi-person-fill all-label-icon"></i><span>Name of Woman</span></label>
                                        <input type="text" id="WomanName" class="all-form-input" placeholder="Enter name" />
                                    </div>
                                    <div class="all-form-group">
                                        <label class="all-form-label"><i class="bi bi-person-heart all-label-icon"></i><span>Husband's Name</span></label>
                                        <input type="text" id="HusbandName" class="all-form-input" placeholder="Enter husband's name" />
                                    </div>
                                    <div class="all-form-group">
                                        <label class="all-form-label"><i class="bi bi-telephone-fill all-label-icon"></i><span>Mobile Number</span></label>
                                        <input type="tel" id="MobileNumber" maxlength="10" class="all-form-input" placeholder="Enter mobile number" required pattern="[0-9]{10}"/>
                                    </div>
                                    <div class="all-form-group">
                                        <label class="all-form-label">
                                            <i class="bi bi-calendar-event all-label-icon"></i>
                                            <span>Month of Marriage</span>
                                        </label>
                                        <select id="MarriageMonth" name="MarriageMonth" class="all-form-input">
                                            <option value="1">January</option>
                                            <option value="2">February</option>
                                            <option value="3">March</option>
                                            <option value="4">April</option>
                                            <option value="5">May</option>
                                            <option value="6">June</option>
                                            <option value="7">July</option>
                                            <option value="8">August</option>
                                            <option value="9">September</option>
                                            <option value="10">October</option>
                                            <option value="11">November</option>
                                            <option value="12">December</option>
                                        </select>
                                        <span asp-validation-for="MarriageMonth" class="text-danger"></span>
                                    </div>


                                    <div class="all-form-group">
                                        <label class="all-form-label">
                                            <i class="bi bi-calendar-event all-label-icon"></i>
                                            <span>Year of Marriage</span>
                                        </label>
                                        <input type="number" id="MarriageYear" min="2010" max="2099" step="1" class="all-form-input" />
                                        <span asp-validation-for="MarriageYear" class="text-danger"></span>
                                    </div>

                                </div>
                            </div>

                            <!-- Children & Pregnancy -->
                            <div class="all-section-card">
                                <div class="all-section-header">
                                    <div class="all-section-icon"><i class="bi bi-baby"></i></div>
                                    <div>
                                        <div class="all-section-title">Children & Pregnancy</div>
                                        <div class="all-section-subtitle">Parity and current pregnancy status</div>
                                    </div>
                                </div>
                                <div class="all-form-grid all-form-grid-2">
                                    <div class="all-form-group">
                                        <label class="all-form-label"><i class="bi bi-people-fill all-label-icon"></i><span>Do you have any children?</span></label>
                                        <select name="IsChildAvailable" class="form-control" id="IsChildAvailable">
                                            <option value="">-- Select --</option>
                                            @foreach (var s in ViewBag.yesNo)
                                            {
                                                <option value="@s.Value" @(Model.IsChildAvailable.ToString() == s.Value ? "selected" : "")>@s.Text</option>
                                            }
                                        </select>
                                    </div>
                                    <div class="all-form-group">
                                        <label class="all-form-label"><i class="bi bi-hourglass all-label-icon"></i><span>Age of the youngest child</span></label>
                                        <input type="number" id="ChildAge" class="all-form-input" maxlength="1"  placeholder="Enter age in years" />
                                    </div>
                                    <div class="all-form-group">
                                        <label class="all-form-label"><i class="bi bi-heart-fill all-label-icon"></i><span>Are you currently pregnant?</span></label>
                                        <select name="IsCurrentlyPregnant" class="form-control" id="IsCurrentlyPregnant">
                                            <option value="">-- Select --</option>
                                            @foreach (var s in ViewBag.yesNo)
                                            {
                                                <option value="@s.Value" @(Model.IsCurrentlyPregnant.ToString() == s.Value ? "selected" : "")>@s.Text</option>
                                            }
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <!-- Family Planning & Antara -->
                            <div class="all-section-card">
                                <div class="all-section-header">
                                    <div class="all-section-icon"><i class="bi bi-capsule"></i></div>
                                    <div>
                                        <div class="all-section-title">Family Planning & Antara</div>
                                        <div class="all-section-subtitle">Current method usage and awareness</div>
                                    </div>
                                </div>
                                <div class="all-form-grid all-form-grid-2">
                                    <div class="all-form-group">
                                        <label class="all-form-label"><i class="bi bi-shield-check all-label-icon"></i><span>Are you using any family planning method?</span></label>
                                        <select name="IsUsingFamilyPlanning" class="form-control" id="IsUsingFamilyPlanning">
                                            <option value="">-- Select --</option>
                                            @foreach (var s in ViewBag.yesNo)
                                            {
                                                <option value="@s.Value" @(Model.IsUsingFamilyPlanning.ToString() == s.Value ? "selected" : "")>@s.Text</option>
                                            }
                                        </select>
                                    </div>
                                    <div class="all-form-group">
                                        <label class="all-form-label"><i class="bi bi-list-check all-label-icon"></i><span>Which family planning method are you using?</span></label>
                                        <select name="FamilyPlanningMethod" class="form-control" id="FamilyPlanningMethod">
                                            <option value="">-- Select --</option>
                                            @foreach (var s in ViewBag.familyplanning)
                                            {
                                                <option value="@s.Value" @(Model.FamilyPlanningMethod.ToString() == s.Value ? "selected" : "")>@s.Text</option>
                                            }
                                        </select>
                                    </div>
                                    <div class="all-form-group">
                                        <label class="all-form-label"><i class="bi bi-info-circle-fill all-label-icon"></i><span>Are you aware of Antara?</span></label>
                                        <select name="IsAwareOfAntara" class="form-control" id="IsAwareOfAntara">
                                            <option value="">-- Select --</option>
                                            @foreach (var s in ViewBag.yesNo)
                                            {
                                                <option value="@s.Value" @(Model.IsAwareOfAntara.ToString() == s.Value ? "selected" : "")>@s.Text</option>
                                            }
                                        </select>
                                    </div>
                                    <div class="all-form-group">
                                        <label class="all-form-label"><i class="bi bi-check2-circle all-label-icon"></i><span>Selected Method Today</span></label>
                                        <input type="text" id="SelectedMethodName" class="all-form-input" placeholder="Enter selected method" />
                                    </div>
                                </div>
                            </div>

                            <!-- Reason For Non Usage -->
                            <div class="all-section-card">
                                <div class="all-section-header">
                                    <div class="all-section-icon"><i class="bi bi-chat-left-text-fill"></i></div>
                                    <div>
                                        <div class="all-section-title">Reason For Non Usage</div>
                                        <div class="all-section-subtitle">Note down any key reasons</div>
                                    </div>
                                </div>
                                <div class="all-form-grid">
                                    <div class="all-form-group" style="grid-column: 1 / -1;">
                                        <label class="all-form-label"><i class="bi bi-pencil-square all-label-icon"></i><span>Reason For Non Usage</span></label>
                                        <textarea class="all-form-textarea" id="ReasonForNonUsage"  placeholder="Enter reason"></textarea>
                                    </div>
                                </div>
                            </div>

                        </div>
                    </div>
                </div>

                <div class="all-modal-footer">
                    <button type="button" id="modalOkBtn" class="all-btn-add">ADD MEMBER</button>
                </div>
            </div>
        </div>
    </div>

    <table class="table table-bordered fh-table mt-3" id="memberTable">
        <thead>
            <tr>
                <th>#</th>
                <th>Name</th>
                <th>Husband</th>
                <th>Mobile</th>
                <th>Pregnant</th>
                <th>FP</th>
                <th>Methods</th>
                <th>
                    <button type="button" class="btn btn-success px-2 py-1" id="addRowBtn">
                        + Member
                    </button>
                </th>
            </tr>
        </thead>
        <tbody id="beneficiaryRows"></tbody>
    </table>

    <hr />

    <button type="button" class="btn-save" onclick="saveMembers()">Save</button>
    <a href="@Url.Action("Index", "LineListingSurvey")" class="btn-back">Back</a>


</form>


<script type="text/template" id="beneficiaryRowTemplate">
    <tr>
        <td class="slno"></td>

        <!-- Name -->
        <td>
            <span class="womanName"></span>
            <input type="hidden" name="Beneficiaries[__index__].WomanName" class="hdWomanName" />
        </td>

        <!-- Husband -->
            <td>
        <span class="husbandName"></span>
        <input type="hidden" name="Beneficiaries[__index__].HusbandName" class="hdHusbandName" />
    </td>


        <!-- Mobile -->
        <td>
            <span class="mobile"></span>
            <input type="hidden" name="Beneficiaries[__index__].MobileNumber" class="hdMobile" />
        </td>

        <!-- Pregnant -->
        <td>
            <span class="pregnant"></span>
            <input type="hidden" name="Beneficiaries[__index__].IsCurrentlyPregnant" class="hdPregnant" />
        </td>

        <!-- Using FP -->
        <td>
            <span class="fp"></span>
            <input type="hidden" name="Beneficiaries[__index__].IsUsingFamilyPlanning" class="hdFP" />
        </td>

        <!-- FP Methods (comma separated for display) -->
        <td>
            <span class="methods"></span>

            <!-- MULTI METHODS -->
            <input type="hidden" name="Beneficiaries[__index__].FamilyPlanningMethod" class="hdMethods" />
        </td>

        <!-- HIDDEN EXTRA FIELDS -->
        <input type="hidden" name="Beneficiaries[__index__].MarriageMonth" class="hdMarriageMonth" />
        <input type="hidden" name="Beneficiaries[__index__].MarriageYear" class="hdMarriageYear" />
        <input type="hidden" name="Beneficiaries[__index__].IsChildAvailable" class="hdChild" />
        <input type="hidden" name="Beneficiaries[__index__].ChildAge" class="hdChildAge" />
        <input type="hidden" name="Beneficiaries[__index__].IsAwareOfAntara" class="hdAntara" />
        <input type="hidden" name="Beneficiaries[__index__].SelectedMethodName" class="hdSelectedMethod" />
        <input type="hidden" name="Beneficiaries[__index__].ReasonForNonUsage" class="hdReason" />

        <td>
            <button type="button" class="btn btn-sm btn-danger removeRow">
                Remove
            </button>
        </td>
    </tr>
</script>


@section Scripts {
    <script>
        // ---------------- CASCADING DROPDOWNS ----------------

            document.getElementById("StateId").addEventListener("change", function () {
                let stateId = this.value;
                resetDropdown("DistrictId", "-- Select District --");
                resetDropdown("BlockId", "-- Select Block --");
                resetDropdown("FacilityId", "-- Select Facility --");

                if (!stateId) return;

                fetch(`/LineListingSurvey/GetDistricts?stateId=${stateId}`)
         .then(res => res.json())
         .then(data => {
             fillDropdown("DistrictId", data, "id", "name");
         });
            });

            document.getElementById("DistrictId").addEventListener("change", function () {
                let districtId = this.value;
                resetDropdown("BlockId", "-- Select Block --");
                resetDropdown("FacilityId", "-- Select Facility --");

                if (!districtId) return;

                fetch(`/LineListingSurvey/GetBlocks?districtId=${districtId}`)
         .then(res => res.json())
         .then(data => {
             fillDropdown("BlockId", data, "id", "name");
         });
            });

            document.getElementById("BlockId").addEventListener("change", function () {
                let blockId = this.value;
                resetDropdown("FacilityId", "-- Select Facility --");

                if (!blockId) return;

                fetch(`/LineListingSurvey/GetFacilities?blockId=${blockId}`)
         .then(res => res.json())
         .then(data => {
             fillDropdown("FacilityId", data, "id", "name");
         });
            });

             document.getElementById("FacilityId").addEventListener("change", function () {
                let blockId = document.getElementById("BlockId").value;
                resetDropdown("SubCenterId", "-- Select Sub-centre --");

                if (!blockId) return;

                fetch(`/LineListingSurvey/GetSubCentre?blockId=${blockId}`)
         .then(res => res.json())
         .then(data => {
             fillDropdown("SubCenterId", data, "id", "name");
         });
            });

        document.getElementById("SubCenterId").addEventListener("change", function () {
                let subcentreId = this.value;
                resetDropdown("AshaId", "-- Select ASHA --");

                if (!subcentreId) return;

                fetch(`/LineListingSurvey/GetAshabySubcentre?subcentreId=${subcentreId}`)
         .then(res => res.json())
         .then(data => {
             fillDropdown("AshaId", data, "id", "name");
         });
            });

            function resetDropdown(id, placeholder) {
                let ddl = document.getElementById(id);
                ddl.innerHTML = `
               <option value="">${placeholder}</option>`;
            }

            function fillDropdown(id, data, valueField, textField) {
                let ddl = document.getElementById(id);
                data.forEach(x => {
         let opt = document.createElement("option");
         opt.value = x[valueField];
         opt.text = x[textField];
         ddl.appendChild(opt);
                });
            }

        // ---------------- OPEN MODAL ----------------
                        document.addEventListener("DOMContentLoaded", function () {
            document.getElementById("addRowBtn").addEventListener("click", function () {
                resetMemberModal();
                let modal = new bootstrap.Modal(
                    document.getElementById("memberModal")
                );
                modal.show();
            });
        });

                function resetMemberModal() {

            // text inputs
            document.querySelectorAll("#memberModal input").forEach(i => {
                if (i.type !== "checkbox") i.value = "";
            });

            // selects
            document.querySelectorAll("#memberModal select").forEach(s => {
                s.selectedIndex = 0;
            });
        }


        //===================Add Row========================

                let participantIndex = 0; // use consistent variable name

        document.addEventListener("DOMContentLoaded", function () {
            document.getElementById("modalOkBtn").addEventListener("click", function () {

                    // 🔁 DUPLICATE CHECK
        let isDuplicate = false;

        document.querySelectorAll("#beneficiaryRows tr").forEach(row => {
            const existingName = row.querySelector(".hdWomanName")?.value;
            const existingMobile = row.querySelector(".hdMobile")?.value;
            const womanName = document.getElementById("WomanName").value.trim();
            if (
                existingName?.toLowerCase() === womanName.toLowerCase() &&
                existingMobile === mobile
            ) {
                isDuplicate = true;
            }
        });

        if (isDuplicate) {
            alert("This member is already added");
            return; // ✅ LEGAL NOW
        }


                const womanName = document.getElementById("WomanName").value.trim();
                const husbandName = document.getElementById("HusbandName").value.trim();
                const mobile = document.getElementById("MobileNumber").value.trim();
                const marriageMonth = document.getElementById("MarriageMonth").value;
                const marriageYear = document.getElementById("MarriageYear").value;

                const isChild = document.getElementById("IsChildAvailable").value;
                const childAge = document.getElementById("ChildAge").value;
                const isPregnant = document.getElementById("IsCurrentlyPregnant").value;
                const isFP = document.getElementById("IsUsingFamilyPlanning").value;
                const isAntara = document.getElementById("IsAwareOfAntara").value;

                const selectedMethod = document.getElementById("SelectedMethodName").value;
                const reason = document.getElementById("ReasonForNonUsage").value;

                const fpChecked = document.getElementById("FamilyPlanningMethod").value;

                if (!womanName) {
                    alert("Please enter woman name");
                    return;
                }

                // Parse template
                let template = document.getElementById("beneficiaryRowTemplate").innerHTML;
                template = template.replace(/__index__/g, participantIndex);

                const temp = document.createElement("tbody");
                temp.innerHTML = template.trim();
                const row = temp.querySelector("tr");

                // Fill visible fields
                row.querySelector(".womanName").textContent = womanName;
                row.querySelector(".husbandName").textContent = husbandName;
                row.querySelector(".mobile").textContent = mobile;
                row.querySelector(".pregnant").textContent = isPregnant === "1" ? "Yes" : "No";
                row.querySelector(".fp").textContent = isFP === "1" ? "Yes" : "No";
                row.querySelector(".methods").textContent = fpChecked.text;

                // Fill hidden fields
                row.querySelector(".hdWomanName").value = womanName;
                row.querySelector(".hdHusbandName").value = husbandName;
                row.querySelector(".hdMobile").value = mobile;
                row.querySelector(".hdMarriageMonth").value = marriageMonth;
                row.querySelector(".hdMarriageYear").value = marriageYear;
                row.querySelector(".hdChild").value = isChild;
                row.querySelector(".hdChildAge").value = childAge
                row.querySelector(".hdPregnant").value = isPregnant;
                row.querySelector(".hdFP").value = isFP;
                row.querySelector(".hdAntara").value = isAntara;
                row.querySelector(".hdSelectedMethod").value = selectedMethod;
                row.querySelector(".hdReason").value = reason;
                row.querySelector(".hdMethods").value = fpChecked;

                // Append row
                document.querySelector("#memberTable tbody").appendChild(row);

               participantIndex++;
                updateSlNo();

                bootstrap.Modal.getInstance(
                    document.getElementById("memberModal")
                ).hide();
            });
        });


        function updateSlNo() {
            document
                .querySelectorAll("#memberTable tbody tr")
                .forEach((row, index) => {
                    row.querySelector(".slno").textContent = index + 1;
                });
        }

        //=====================Romove and Reindex====================

                document.addEventListener("click", function (e) {
            if (e.target.classList.contains("removeRow")) {
                e.target.closest("tr").remove();
                reIndexBeneficiaries();
            }
        });

        function reIndexBeneficiaries() {
            const rows = document.querySelectorAll("#beneficiaryRows tr");

            rows.forEach((row, index) => {
                row.querySelector(".slno").textContent = index + 1;

                row.querySelectorAll("input[name]").forEach(input => {
                    input.name = input.name.replace(/\[\d+\]/, `[${index}]`);
                });
            });

            beneficiaryIndex = rows.length;
        }

        //========================================saveMembers==============================

                function saveMembers() {

                         // ---------- HEADER VALIDATION ----------
        const requiredFields = [
            { id: "StateId", name: "State" },
            { id: "DistrictId", name: "District" },
            { id: "BlockId", name: "Block" },
            { id: "FacilityId", name: "Facility" },
            { id: "SubCenterId", name: "Sub Center" },
            { id: "AshaId", name: "ASHA" }
        ];

        for (let f of requiredFields) {
            if (!document.getElementById(f.id).value) {
                alert(`Please select ${f.name}`);
                return;
            }
        }

        const village = document.querySelector('[name="VillageName"]').value.trim();
        if (!village) {
            alert("Please enter Village Name");
            return;
        }

        // ---------- MEMBER VALIDATION ----------
        const rows = document.querySelectorAll("#beneficiaryRows tr");
        if (rows.length === 0) {
            alert("Please add at least one beneficiary");
            return;
        }

            const women = [];

            document.querySelectorAll("#beneficiaryRows tr").forEach(row => {

                women.push({
                    WomanName: row.querySelector(".hdWomanName")?.value,
                    HusbandName: row.querySelector(".hdHusbandName")?.value,
                    MobileNumber: row.querySelector(".hdMobile")?.value,

                    MarriageMonth: row.querySelector(".hdMarriageMonth")?.value || null,
                    MarriageYear: row.querySelector(".hdMarriageYear")?.value || null,
                    IsChildAvailable: row.querySelector(".hdChild")?.value || null,
                    ChildAge: row.querySelector(".hdChildAge")?.value || null,
                    IsCurrentlyPregnant: row.querySelector(".hdPregnant")?.value || null,
                    IsUsingFamilyPlanning: row.querySelector(".hdFP")?.value || null,

                    IsAwareOfAntara: row.querySelector(".hdAntara")?.value || null,
                    SelectedMethodName: row.querySelector(".hdSelectedMethod")?.value || null,
                    ReasonForNonUsage: row.querySelector(".hdReason")?.value || null,

                    FamilyPlanningMethod: row.querySelector(".hdMethods")?.value || null
                });
            });

            if (women.length === 0) {
                alert("Please add at least one beneficiary");
                return;
            }

            const model = {
                StateId: document.getElementById("StateId").value || null,
                DistrictId: document.getElementById("DistrictId").value || null,
                BlockId: document.getElementById("BlockId").value || null,
                FacilityId: document.getElementById("FacilityId").value || null,
                SubCenterId: document.getElementById("SubCenterId").value || null,
                ASHAId: document.getElementById("AshaId").value || null,
                VillageName: document.querySelector('[name="VillageName"]').value || null,
                AnganwadiWorkerName: document.querySelector('[name="AnganwadiWorkerName"]').value || null,
                Women: women
            };

            fetch('/LineListingSurvey/Create', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'RequestVerificationToken':
                        document.querySelector('input[name="__RequestVerificationToken"]').value
                },
                body: JSON.stringify(model)
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    alert("Saved successfully!");
                    window.location.href = "/LineListingSurvey/Index";
                } else {
                    alert(data.message || "Save failed");
                }
            })
            .catch(err => {
                console.error(err);
                alert("Error while saving");
            });
        }
    </script>
}