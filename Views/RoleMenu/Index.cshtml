@using Vikalp.Models.DTO
@model IEnumerable<Vikalp.Models.DTO.RoleMenuDTO>

@{
    ViewData["Title"] = "Role Menu Mapping";
    Layout = "~/Views/Shared/_AdminLayout.cshtml";
}

<style>
    #RoleMenu-record {
        padding: 10px;
    }
</style>

<style>
    .um-action {
        white-space: nowrap;
    }
    /* Small, focused styles for the user management page */
    .um-card {
        border-radius: 0.5rem;
        box-shadow: 0 6px 18px rgba(12, 38, 63, 0.08);
    }

    .um-toolbar {
        gap: .5rem;
        display: flex;
        align-items: center;
        flex-wrap: wrap;
    }

    .um-search {
        max-width: 320px;
    }

    .um-table thead th {
        /* background: linear-gradient(90deg,#0d6efd, #6610f2);
                        color: #fff;
                        border: 0; */
        color: #fff;
        border: 1px dotted;
        background: var(--ipas-sidebar);
    }

    .um-table tbody tr:hover {
        background: rgba(13,110,253,0.03);
    }

    .um-action .btn {
        min-width: 44px;
    }

    .um-badge-role {
        font-size: .8rem;
        padding: .25rem .45rem;
        border-radius: .25rem;
    }

    .um-empty {
        padding: 2rem;
        text-align: center;
        color: #6c757d;
    }

    .um-action a,
    .um-action button {
        position: relative;
        z-index: 10;
        pointer-events: auto;
    }

    .um-action svg {
        pointer-events: none;
    }

    .table-responsive {
        position: relative;
        z-index: 1;
    }

    .btn-add {
        background-color: #3F0C11;
        color: white;
    }

    .umcard-header {
        background: linear-gradient(135deg, #F15A29, #b10315b5);
        color: #ffffff;
        padding: 10px 20px;
    }

    .menu-badge {
        display: inline-block;
        padding: 6px 12px;
        margin: 3px 5px 3px 0;
        font-size: 13px;
        font-weight: 500;
        border-radius: 20px;
        background-color: #e9f2ff;
        color: #0d6efd;
        border: 1px solid #cfe2ff;
    }

        .menu-badge:hover {
            background-color: #0d6efd;
            color: #fff;
            transition: 0.2s ease-in-out;
        }

    .role-icon {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        color: #fff;
        font-size: 18px;
        margin-right: 10px;
    }

    .bg-blue {
        background-color: #0d6efd;
    }

    .bg-green {
        background-color: #198754;
    }

    .bg-orange {
        background-color: #fd7e14;
    }

    .bg-purple {
        background-color: #6f42c1;
    }

    .bg-red {
        background-color: #dc3545;
    }

    .bg-teal {
        background-color: #20c997;
    }

    .bg-dark {
        background-color: #343a40;
    }

    .menu-badge {
        display: inline-flex;
        align-items: center;
        padding: 6px 12px;
        margin: 3px 5px 3px 0;
        font-size: 13px;
        font-weight: 500;
        border-radius: 20px;
        color: #fff;
        position: relative;
        transition: 0.2s ease-in-out;
    }

        .menu-badge:hover {
            transform: scale(1.05);
        }

    .menu-remove {
        margin-left: 8px;
        font-weight: bold;
        cursor: pointer;
        font-size: 14px;
        opacity: 0.8;
    }

        .menu-remove:hover {
            opacity: 1;
        }

</style>


<div class="container-fluid" id="RoleMenu-record">
    @Html.AntiForgeryToken()
    <div class="card um-card mb-3">
        <div class="card-body">
            <div class="umcard-header">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h3 class="mb-0">Role Menu Mapping</h3>
                    </div>
                </div>
            </div>
            <hr />
                <!-- Table -->
                <div class="table-responsive">
                    <table id="activitiesTable" class="table table-striped um-table align-middle">
                        <thead>
                            <tr>
                                <th><i class="bi bi-person-fill me-2"></i>Role Name</th>
                                <th><i class="bi bi-person me-2"></i>Assigned Menus</th>
                                <th><i class="bi bi-pencil-square me-2"></i>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var item in Model)
                            {
                                <tr>
                                    <td><span class="role-icon bg-orange"><i class="@item.Icon"></i></span>@item.RoleName</td>
                                    <td>
                                        @if (!string.IsNullOrEmpty(item.MenuNames))
                                        {
                                            var menus = item.MenuNames.Split(',');

                                        @* foreach (var menu in menus)
                                        {
                                            var trimmedMenu = menu.Trim();
                                            <span class="menu-badge menu-color"
                                                  data-roleid="@item.RoleId"
                                                  data-menuname="@trimmedMenu">
                                                @trimmedMenu
                                                <span class="menu-remove"
                                                      onclick="unassignMenu(@item.RoleId, '@trimmedMenu')">
                                                    &times;
                                                </span>
                                            </span>
                                        } *@
                                        @if (!string.IsNullOrEmpty(item.MenuIds) && !string.IsNullOrEmpty(item.MenuNames))
                                        {
                                            var ids = item.MenuIds.Split(',');
                                            var names = item.MenuNames.Split(',');

                                            for (int i = 0; i < ids.Length; i++)
                                            {
                                                var menuId = ids[i].Trim();
                                                var menuName = names.Length > i ? names[i].Trim() : "";

                                                <span class="menu-badge menu-color"
                                                      data-roleid="@item.RoleId"
                                                      data-menuid="@menuId">

                                                    @menuName

                                                    <span class="menu-remove"
                                                          onclick="unassignMenu(@item.RoleId, @menuId)">
                                                        &times;
                                                    </span>
                                                </span>
                                            }
                                        }
                                        }
                                    </td>

                                    <td class="text-end um-action">
                                        <button type="button"
                                                class="btn btn-sm btn-outline-primary"
                                                onclick="openMenuPopup(@item.RoleId)"
                                                title="Edit Role Menu">
                                            <i class="bi bi-pencil"></i>
                                        </button>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>

            <!-- Role Menu Modal -->
            <div class="modal fade" id="roleMenuModal" tabindex="-1">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">

                        <div class="modal-header">
                            <h5 class="modal-title">
                                <i class="bi bi-list-check me-2"></i>Assign Menus
                            </h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>

                        <div class="modal-body">
                            <input type="hidden" id="selectedRoleId" />

                            <div id="menuCheckboxContainer" class="row">
                                <!-- Menus will load here -->
                            </div>
                        </div>

                        <div class="modal-footer">
                            <button type="button"
                                    class="btn-back"
                                    data-bs-dismiss="modal">
                                Cancel
                            </button>

                            <button type="button"
                                    class="btn-save"
                                    onclick="saveRoleMenus()">
                                <i class="bi bi-save me-1"></i>Save
                            </button>
                        </div>

                    </div>
                </div>
            </div>

        </div>
    </div>
</div>

<script>
        function openMenuPopup(roleId) {

        document.getElementById("selectedRoleId").value = roleId;

        fetch('/RoleMenu/GetMenusByRole?roleId=' + roleId)
            .then(response => response.json())
            .then(res => {

                let html = '';

                res.forEach(menu => {

                    html += `
                        <div class="col-md-4 mb-2">
                            <div class="form-check">
                                <input class="form-check-input menu-checkbox"
                                       type="checkbox"
                                       value="${menu.menuId}"
                                       ${menu.roleMenuId ? 'checked' : ''}>
                                <label class="form-check-label">
                                    ${menu.menuName}
                                </label>
                            </div>
                        </div>`;
                });

                document.getElementById("menuCheckboxContainer").innerHTML = html;

                var modal = new bootstrap.Modal(document.getElementById('roleMenuModal'));
                modal.show();
            })
            .catch(error => {
                console.error("Error loading menus:", error);
            });
    }


        function saveRoleMenus() {

        var roleId = document.getElementById("selectedRoleId").value;

        var checkboxes = document.querySelectorAll(".menu-checkbox:checked");

        var selectedMenus = [];

        checkboxes.forEach(function (checkbox) {
            selectedMenus.push(parseInt(checkbox.value));
        });

        fetch('/RoleMenu/SaveRoleMenuMapping', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                roleId: parseInt(roleId),
                menuIds: selectedMenus
            })
        })
        .then(response => response.json())
        .then(res => {
            if (res.success) {
                alert("Mapping Saved Successfully");
                location.reload();
            } else {
                alert("Error saving mapping");
            }
        })
        .catch(error => console.error(error));
    }

    document.addEventListener("DOMContentLoaded", function () {

        const colors = [
            "#0d6efd", "#198754", "#fd7e14",
            "#6f42c1", "#dc3545", "#20c997",
            "#6610f2", "#d63384", "#198754",
            "#0dcaf0"
        ];

        document.querySelectorAll(".menu-color").forEach(function (badge) {
            const randomColor = colors[Math.floor(Math.random() * colors.length)];
            badge.style.backgroundColor = randomColor;
        });

    });

       function unassignMenu(roleId, menuId) {

        if (!confirm("Are you sure you want to unassign this menu?"))
            return;

        const token = document.querySelector(
            'input[name="__RequestVerificationToken"]'
        ).value;

        fetch('/RoleMenu/UnassignMenu', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'RequestVerificationToken': token
            },
            body: JSON.stringify({
                roleId: roleId,
                menuId: menuId
            })
        })
        .then(res => {
            if (!res.ok) throw new Error("Network response not ok");
            return res.json();
        })
        .then(data => {
            if (data.success) {
                document.querySelector(
                    `[data-roleid='${roleId}'][data-menuid='${menuId}']`
                ).remove();
            }
        })
        .catch(err => console.error("Error:", err));
    }

</script>

