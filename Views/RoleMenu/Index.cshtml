@using Microsoft.AspNetCore.Mvc.Rendering
@using Vikalp.Models.DTO

@{
    ViewData["Title"] = "Role Menu Master";
    Layout = "~/Views/Shared/_AdminLayout.cshtml";
}

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" />

<style>
    .um-card {
        border-radius: 0.5rem;
        box-shadow: 0 6px 18px rgba(12, 38, 63, 0.08);
    }

    .menu-checkboxes {
        display: flex;
        flex-wrap: wrap;
        gap: 20px;
        margin-top: 15px;
    }

    .parent-menu {
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 15px;
        min-width: 250px;
        flex: 1 1 250px;
        background-color: #f9f9f9;
        transition: all 0.2s ease-in-out;
        display: flex;
        flex-direction: column;
    }

        .parent-menu:hover {
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

    .parent-menu-header {
        background-color: #007bff;
        color: white;
        padding: 8px 12px;
        border-radius: 5px;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 5px;
    }

    .child-menu-checkboxes {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-top: 10px;
    }

        .child-menu-checkboxes .form-check {
            border: 1px solid #ccc;
            border-radius: 5px;
            padding: 5px 10px;
            background-color: #fff;
            transition: all 0.2s;
        }

            .child-menu-checkboxes .form-check:hover {
                background-color: #e7f3ff;
                border-color: #007bff;
            }

    .child-checkbox {
        margin-right: 5px;
    }

    .container-full {
        min-height: calc(100vh - 120px);
        display: flex;
        flex-direction: column;
        padding: 20px;
    }

    .menu-checkboxes {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
        gap: 20px;
        flex: 1; 
        overflow-y: auto;
        padding: 10px;
    }

  
    .parent-menu {
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 10px;
        background-color: #f9f9f9;
        display: flex;
        flex-direction: column;
        transition: all 0.2s;
    }

        .parent-menu:hover {
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

 
    .parent-menu-header {
        background-color: #007bff;
        color: #fff;
        font-weight: 600;
        padding: 8px 12px;
        border-radius: 5px;
        display: flex;
        align-items: center;
        gap: 5px;
    }


    .child-menu-checkboxes {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-top: 10px;
    }

       
        .child-menu-checkboxes .form-check {
            border: 1px solid #ccc;
            border-radius: 5px;
            padding: 5px 10px;
            background-color: #fff;
        }

            .child-menu-checkboxes .form-check:hover {
                background-color: #e7f3ff;
                border-color: #007bff;
            }

</style>


<div class="container-full">
    <div class="card um-card" style="flex:1; display:flex; flex-direction:column;">
        <div class="card-body" style="flex:1; display:flex; flex-direction:column;">

            <h4 class="mb-3">Role Menu Mapping</h4>

            <form id="RoleMenuForm" method="post" style="display:flex; flex-direction:column; flex:1;">

                <div class="form-group mb-3">
                    <label class="form-label">Role</label>
                    <select id="RoleId" name="RoleId" class="form-control">
                        <option value=""> Select Role </option>
                        @foreach (var r in ViewBag.RoleList as SelectList)
                        {
                            <option value="@r.Value">@r.Text</option>
                        }
                    </select>
                </div>

                <div id="ParentMenuContainer" class="menu-checkboxes"></div>
      
 <button type="submit" id="SaveMappingBtn"  class="btn btn-primary mt-3" style="align-self:flex-start; display:none;">  Save Mapping  </button>

            </form>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<script>
    $(document).ready(function () {

        $('#SaveMappingBtn').hide();
        loadAllMenusDisabled();

        function loadChildMenus(parentMenuId, roleId) {
            var container = $('#child_container_' + parentMenuId);
            container.empty();

            $.get('@Url.Action("GetChildMenus", "RoleMenu")',
                { parentMenuId: parentMenuId, roleId: roleId },
                function (children) {
                    $.each(children, function (j, child) {
                        container.append(`
                            <div class="form-check">
                                <input type="checkbox" class="child-checkbox"
                                       value="${child.menuId}"
                                       id="child_${child.menuId}"
                                       ${child.isActive ? 'checked' : ''}>
                                <label for="child_${child.menuId}">${child.menuName}</label>
                            </div>
                        `);
                    });
                });
        }

        $('#RoleId').change(function () {
            var roleId = $(this).val();
            $('#ParentMenuContainer').empty();

            if (!roleId) {
                $('#SaveMappingBtn').hide();
                loadAllMenusDisabled();
                return;
            }

            $('#SaveMappingBtn').show();

            $.get('@Url.Action("GetMenusByRole", "RoleMenu")', { roleId: roleId }, function (data) {
                $.each(data, function (i, parent) {
                    $('#ParentMenuContainer').append(`
                        <div class="parent-menu">
                            <div class="parent-menu-header">
                                <input type="checkbox"
                                       class="parent-checkbox"
                                       data-menuid="${parent.menuId}"
                                       id="parent_${parent.menuId}"
                                       ${parent.isActive ? 'checked' : ''}>
                                <label for="parent_${parent.menuId}">${parent.menuName}</label>
                            </div>
                            <div class="child-menu-checkboxes"
                                 id="child_container_${parent.menuId}">
                            </div>
                        </div>
                    `);

                    loadChildMenus(parent.menuId, roleId);
                });
            });
        });


        $('#ParentMenuContainer').on('change', '.parent-checkbox', function () {
            var parentMenuId = $(this).data('menuid');
            $('#child_container_' + parentMenuId + ' .child-checkbox')
                .prop('checked', $(this).is(':checked'));
        });

      
        $('#ParentMenuContainer').on('change', '.child-checkbox', function () {
            var container = $(this).closest('.child-menu-checkboxes');
            var parentCheckbox = container.closest('.parent-menu').find('.parent-checkbox');
            parentCheckbox.prop('checked', container.find('.child-checkbox:checked').length > 0);
        });

        $('#RoleMenuForm').submit(function (e) {
            e.preventDefault();

            var roleId = $('#RoleId').val();
            if (!roleId) {
                alert('Please select a role');
                return;
            }

            var mappings = [];

            $('.parent-checkbox').each(function () {
                var parentId = $(this).data('menuid');
                var childIds = [];

                $('#child_container_' + parentId + ' .child-checkbox:checked').each(function () {
                    childIds.push(parseInt($(this).val()));
                });

                if (childIds.length > 0) {
                    mappings.push({
                        ParentMenuId: parentId,
                        ChildMenuIds: childIds
                    });
                }
            });

            $.ajax({
                url: '@Url.Action("SaveRoleMenuMapping", "RoleMenu")',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ RoleId: roleId, Mappings: mappings }),
                success: function (res) {
                    alert(res.success ? 'Mapping saved successfully' : 'Save failed');
                }
            });
        });


        function loadAllMenusDisabled() {
            $('#ParentMenuContainer').empty();

            $.get('@Url.Action("GetAllMenus", "RoleMenu")', function (data) {
                $.each(data, function (i, parent) {
                    $('#ParentMenuContainer').append(`
                        <div class="parent-menu">
                            <div class="parent-menu-header">
                                <input type="checkbox" disabled>
                                <label>${parent.menuName}</label>
                            </div>
                            <div class="child-menu-checkboxes"
                                 id="child_container_${parent.menuId}">
                            </div>
                        </div>
                    `);

                    loadAllChildMenusDisabled(parent.menuId);
                });
            });
        }

        function loadAllChildMenusDisabled(parentMenuId) {
            $.get('@Url.Action("GetAllChildMenus", "RoleMenu")',
                { parentMenuId: parentMenuId },
                function (children) {
                    var container = $('#child_container_' + parentMenuId);
                    container.empty();

                    $.each(children, function (j, child) {
                        container.append(`
                            <div class="form-check">
                                <input type="checkbox" disabled>
                                <label>${child.menuName}</label>
                            </div>
                        `);
                    });
                });
        }

    });
</script>
