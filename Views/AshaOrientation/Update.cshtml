@using Vikalp.Models.DTO
@model Vikalp.Models.DTO.AshaOrientationCreateDto
@{
    ViewData["Title"] = "ASHA Orientation Update";
    Layout = "~/Views/Shared/_AdminLayout.cshtml";
}

<style>
    #orientationForm {
        padding: 20px;
        max-width: 1400px;
        margin: 0 auto;
    }

    /* Facility Type Section */
    .form-card {
        background: #fff;
        border-radius: 8px;
        padding: 10px;
        margin-bottom: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .section-title {
        align-items: center;
        gap: 15px;
        margin-bottom: 20px;
        font-size: 18px;
        font-weight: 600;
        color: #333;
    }

        .section-title i {
            font-size: 24px;
            color: #0d6efd;
        }

    .fh-header {
        display: flex;
        gap: 20px;
        margin-left: auto;
    }

    .facility-type-card {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 5px 19px;
        border: 2px solid #dee2e6;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s ease;
        background: #f8f9fa;
    }



        .facility-type-card input[type="radio"] {
            cursor: pointer;
            width: 18px;
            height: 18px;
        }

        .facility-type-card label {
            cursor: pointer;
            margin: 0;
            font-size: 15px;
            font-weight: 500;
        }

    /* Card Header Section */
    .card {
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        margin-bottom: 20px;
    }

    .fh-cardHeader {
        align-items: center;
        justify-content: space-between;
        padding: 10px 0;
    }

        .fh-cardHeader h2 {
            margin: 0;
            font-size: 18px;
            font-weight: 600;
            color: #F15A29;
        }

        .fh-cardHeader .col-md-4 {
            display: flex;
            align-items: center;
            gap: 12px;
        }

            .fh-cardHeader .col-md-4 label {
                white-space: nowrap;
                margin: 0;
                font-weight: 500;
                min-width: 120px;
            }

            .fh-cardHeader .col-md-4 input {
                flex: 1;
            }


    .btn {
        padding: 8px;
        font-weight: 500;
    }

    .btn-success {
        margin: 0;
    }



    /* Hidden utility */
    .d-none {
        display: none !important;
    }

    .fh-section-title {
        align-items: center;
        gap: 15px;
        /* margin-bottom: 20px; */
        font-size: 14px;
        font-weight: 600;
        color: #333;
    }

    .fh-cardBody {
        padding: 1px 10px;
        flex: 1 1 auto;
    }

    .btn-topics {
        height: 32px;
        line-height: 15px;
    }

    .table thead tr th, .table tbody tr th {
        vertical-align: middle;
    }

    .fh-modal-header {
        color: #F15A29;
    }
</style>

<form asp-action="Create" method="post" id="orientationForm">
    @Html.AntiForgeryToken()
    <input type="hidden" id="VenueGuid" value="@Model.VenueGuid" />
    <input type="hidden" id="hdnDistrictId" value="@Model.DistrictId" />
    <input type="hidden" id="hdnBlockId" value="@Model.BlockId" />
    <input type="hidden" id="hdnFacilityId" value="@Model.FacilityId" />
    <input type="hidden" id="hdnTopics" value='@System.Text.Json.JsonSerializer.Serialize(Model.TopicsCovered ?? new List<int>())' />
    <input type="hidden" id="isEditMode" value="@(Model != null && Model.VenueGuid != null ? "1" : "0")" />



    <div class="form-card">
        <div class="fh-section-title d-flex">
            <i class="bi bi-gear"></i>
            Select Facility Type

            <div class="fh-header">
                <div class="facility-type-card" id="interventionCard">
                    <input name="IsIntervention" class="form-check-input" type="radio" id="intervention" value="1" onchange="handleFacilityTypeChange()" />

                    <label class="form-check-label" for="intervention">Intervention</label>
                </div>
                <div class="facility-type-card" id="nonInterventionCard">
                    <input name="IsIntervention" class="form-check-input" type="radio" id="nonIntervention" value="0" onchange="handleFacilityTypeChange()" />

                    <label class="form-check-label" for="nonIntervention">Non-Intervention</label>
                </div>
            </div>
        </div>
    </div>
    <div class="card">
        <div class="fh-cardBody">
            <div class="fh-cardHeader d-flex gap-5">
                <h2>ASHA Orientation Entry</h2>

                <div class="col-md-4 d-flex">
                    <label>Orientation Date</label>
                    <input type="date"
                           name="DateofOrientation"
                           value="@Model.DateofOrientation.ToString("yyyy-MM-dd")"
                           class="form-control-sm" />
                    <span asp-validation-for="DateofOrientation" class="text-danger"></span>

                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-md-2">
            <label>State</label>
            <select name="StateId" class="form-control-sm" id="StateId">
                <option value="">-- Select State --</option>
                @foreach (var s in ViewBag.States)
                {
                    <option value="@s.Id" @(Model.StateId == s.Id ? "selected" : "")>@s.Name</option>
                }
            </select>
        </div>

        <div class="col-md-2">
            <label>District</label>
            <select name="DistrictId" class="form-control-sm" id="DistrictId">
                <option value="">-- Select District --</option>
            </select>
        </div>

        <div class="col-md-2">
            <label>Block</label>
            <select name="BlockId" class="form-control-sm" id="BlockId">
                <option value="">-- Select Block --</option>
            </select>
        </div>

        <div class="col-md-2" id="facilityDropdownDiv">
            <label>Facility</label>
            <select name="FacilityId" class="form-control-sm" id="FacilityId">
                <option value="">-- Select Facility --</option>
            </select>
        </div>

        <div class="col-md-2 d-none" id="manualFacilityDiv">
            <label>Facility</label>
            <input name="FacilityName" id="FacilityName" class="form-control-sm" placeholder="Enter Facility name" />
        </div>

        <div class="col-md-2">
            <label>Facility NIN</label>
            <input name="NIN" id="NinNumber" class="form-control-sm" placeholder="Enter NIN" />
        </div>
        <div class="col-md-2">
            <label>Topic Covered</label>

            <div class="dropdown">
                <button class="btn btn-outline-secondary dropdown-toggle w-100 text-start"
                        type="button"
                        id="topicsDropdownBtn"
                        data-bs-toggle="dropdown"
                        aria-expanded="false">
                    Select Topics
                </button>

                <ul class="dropdown-menu w-100 p-2" aria-labelledby="topicsDropdownBtn"
                    style="max-height: 250px; overflow-y: auto;">
                    @if (ViewBag.Topics != null)
                    {
                        @foreach (var topic in ViewBag.Topics)
                        {
                            var topicId = "topic_" + topic.Id;

                            <li>
                                <div class="form-check">
                                    <input class="form-check-input topic-checkbox"
                                           type="checkbox"
                                           value="@topic.Id"
                                           id="@topicId" />

                                    <label class="form-check-label" for="@topicId">
                                        @topic.Name
                                    </label>
                                </div>
                            </li>
                        }
                    }
                </ul>
            </div>
        </div>
    </div>
    <!-- ASHA ROWS WILL COME HERE (Part 2B) -->
    <table class="table table-bordered fh-table mt-3">
        <thead>
            <tr>
                <th>#</th>
                <th class="fw-semibold">Venue</th>
                <th class="fw-semibold">ASHA</th>
                <th class="fw-semibold">Mobile</th>
                <th class="fw-semibold">VCAT Pre</th>
                <th class="fw-semibold">VCAT Post</th>
                <th class="fw-semibold">Oriented</th>
                <th>
                    <button type="button" class="btn btn-success px-2 py-1" id="addRowBtn">
                        + Add ASHA
                    </button>
                </th>
            </tr>
        </thead>
        <tbody id="ashaRows">
        </tbody>
    </table>
    <hr />

    @* <button type="submit" class="btn btn-primary">Save</button> *@
    <button type="button" class="btn btn-primary btn-sm" onclick="saveOrientation()">Update</button>
    <a href="@Url.Action("Index", "AshaOrientation")" class="btn btn-secondary btn-sm">Back</a>


    <div class="modal fade" id="ashaModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title fh-modal-header">Add ASHA</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>

                <div class="modal-body">
                    <div class="mb-3">
                        <label>Facility Type <span class="text-danger">*</span></label>
                        <select id="modalFacilityType" class="form-control">
                            <option value="">-- Select --</option>
                            <option value="intervention">Intervention</option>
                            <option value="non-intervention">Non-Intervention</option>
                        </select>
                    </div>
                    <div class="mb-3" id="modalFacilityDiv">
                        <label>Facility</label>
                        <input type="text" id="facilitySearch" class="form-control" placeholder="Search facility..." />
                        <input type="hidden" id="selectedFacilityId" />
                        <div id="facilityResults" class="list-group"></div>
                    </div>

                    @* <div class="mb-3" id="modalAshaDropdownDiv">
                        <label>ASHA</label>
                        <select id="modalAsha" class="form-control">
                            <option value="">-- Select ASHA --</option>
                        </select>
                    </div> *@
                    <div class="mb-3" id="modalAshaListDiv">
                        <label>Select ASHA(s)</label>

                        <div class="border rounded p-2" style="max-height:300px; overflow-y:auto;">
                            <table class="table table-sm table-bordered mb-0">
                                <thead>
                                    <tr>
                                        <th>Select</th>
                                        <th>ASHA Name</th>
                                        <th>Mobile</th>
                                        <th>Facility</th>
                                        <th>Sub-Center</th>
                                    </tr>
                                </thead>
                                <tbody id="ashaListBody">
                                    <!-- ASHAs loaded dynamically -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div class="mb-3 d-none" id="modalfacilityTextDiv">
                        <label>Venue Name</label>
                        <input type="text" id="modalfacilityText" class="form-control" placeholder="Enter Facility name" />
                    </div>

                    <div class="mb-3 d-none" id="modalAshaTextDiv">
                        <label>ASHA Name</label>
                        <input type="text" id="modalAshaText" class="form-control" placeholder="Enter ASHA name" />
                    </div>
                    <div class="mb-3 d-none" id="modalAshaMobDiv">
                        <label>Mobile Number</label>
                        <input type="text" id="modelMobNumber" class="form-control" maxlength="10" pattern="\d{10}" placeholder="Enter Mobile Number" />
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" id="modalOkBtn">OK</button>
                </div>
            </div>
        </div>
    </div>

</form>
<script type="text/template" id="ashaRowTemplate">
        <tr>
            <td class="rowIndex"></td>

            <td>
                        <input type="hidden" name="Attendees[__index__].FacilityId" class="facilityIdHidden" />
                <input name="Attendees[__index__].FacilityName" class="form-control venueInput" readonly />
            </td>
            <td>
                <input type="hidden" name="Attendees[__index__].AshaId" class="ashaIdHidden" />

        <input name="Attendees[__index__].AshaName" class="form-control ashaNameInput" readonly />
            </td>

            <td>
                <input name="Attendees[__index__].AshaMobile" class="form-control mobileInput" readonly />
            </td>

            <td>
                <input name="Attendees[__index__].VCAT_PreTest" type="number" min="0" max="99" class="form-control" />
            </td>

            <td>
                <input name="Attendees[__index__].VCAT_PostTest" type="number" min="0" max="99" class="form-control" />
            </td>

               <td class="text-center">
        <input type="hidden" name="Attendees[__index__].IsOrientation" value="0" />
        <input type="checkbox"
               class="is-orientation"
               value="1"
               onchange="this.previousElementSibling.value = this.checked ? 1 : 0" />
    </td>


            <td>
                <button type="button" class="btn btn-danger btn-sm removeRow">Remove</button>
            </td>
        </tr>
</script>
@section Scripts {
    <script>
                        let rowIndex = @Model.Attendees?.Count() ?? 0;

                    // ---------------- FACILITY TYPE TOGGLE ----------------
                                    function handleFacilityTypeChange() {

                let selected = document.querySelector(
                    'input[name="IsIntervention"]:checked'
                );

                let isIntervention = selected && selected.value === "1";

                let facilityDropdown = document.getElementById("facilityDropdownDiv");
                let manualFacility = document.getElementById("manualFacilityDiv");

                if (isIntervention) {
                    facilityDropdown.classList.remove("d-none");
                    manualFacility.classList.add("d-none");
                } else {
                    facilityDropdown.classList.add("d-none");
                    manualFacility.classList.remove("d-none");
                }
            }



                            document.addEventListener("DOMContentLoaded", function () {

                    handleFacilityTypeChange(); // already exists

                    let stateId = document.getElementById("StateId").value;
                    let districtId = document.getElementById("hdnDistrictId").value;
                    let blockId = document.getElementById("hdnBlockId").value;
                    let facilityId = document.getElementById("hdnFacilityId").value;

                    if (stateId) {
                        loadDistricts(stateId, districtId);
                    }
                });

                    // ---------------- OPEN MODAL ----------------
                                    document.addEventListener("DOMContentLoaded", function () {
                        document.getElementById("addRowBtn").addEventListener("click", function () {
                            resetAshaModal();
                            let modal = new bootstrap.Modal(
                                document.getElementById("ashaModal")
                            );
                            modal.show();
                        });
                    });

                    // ---------------- ADD ROW ON OK ----------------
                            document.addEventListener("DOMContentLoaded", function () {

                         document.getElementById("modalOkBtn").addEventListener("click", function () {

                        let type = document.getElementById("modalFacilityType").value;

                        if (type === "intervention") {

                            let selected = document.querySelectorAll(".asha-check:checked");

                            if (selected.length === 0) {
                                alert("Please select at least one ASHA");
                                return;
                            }

                            selected.forEach(chk => {
                                        addRowWithData(
                        chk.dataset.id,
                        chk.dataset.facilityid,
                        chk.dataset.facilityname,
                        chk.dataset.name,
                        chk.dataset.mobile
                    );
                            });
                        }
                        else if (type === "non-intervention") {

                            let ashaName = document.getElementById("modalAshaText").value;
                            let Venue = document.getElementById("modalAshaText").value;
                            let mobile = document.getElementById("modelMobNumber").value;

                            if (!ashaName) {
                                alert("Please enter ASHA name");
                                return;
                            }

                            addRowWithData(0, 0, Venue, ashaName, mobile);
                        }

                        let modal = bootstrap.Modal.getInstance(document.getElementById("ashaModal"));
                        modal.hide();
                    });


                    });

                    function addRowWithData(ashaId, facilityId, Venue, ashaName, mobile) {
                        let template = document.getElementById("ashaRowTemplate").innerHTML;
                        template = template.replaceAll("__index__", rowIndex);

                        let tbody = document.getElementById("ashaRows");
                        let tempDiv = document.createElement("tbody");
                        tempDiv.innerHTML = template;

                        let row = tempDiv.firstElementChild;
                                row.querySelector(".ashaIdHidden").value = ashaId;
                                row.querySelector(".facilityIdHidden").value = facilityId;
                    row.querySelector(".venueInput").value = Venue;
                    row.querySelector(".ashaNameInput").value = ashaName;
                    row.querySelector(".mobileInput").value = mobile;

                        tbody.appendChild(row);
                        updateRowNumbers();
                        rowIndex++;
                    }

                    // ---------------- REMOVE ROW ----------------
                    document.addEventListener("click", function (e) {
                        if (e.target.classList.contains("removeRow")) {
                            e.target.closest("tr").remove();
                            updateRowNumbers();
                        }
                    });

                    function updateRowNumbers() {
                        document.querySelectorAll("#ashaRows tr").forEach((row, i) => {
                            row.querySelector(".rowIndex").innerText = i + 1;
                        });
                    }

                    // ---------------- FACILITY SEARCH (DEBOUNCE) ----------------
                    let typingTimer;
                    let doneTypingInterval = 1200;

                    document.getElementById("facilitySearch").addEventListener("keyup", function () {
                        clearTimeout(typingTimer);
                        let term = this.value;

                        if (term.length < 1) return;

                        typingTimer = setTimeout(function () {
                            searchFacilities(term);
                        }, doneTypingInterval);
                    });

                    function searchFacilities(term) {
                        fetch(`/AshaOrientation/SearchFacilities?term=${term}`)
                            .then(res => res.json())
                            .then(data => {
                                let list = document.getElementById("facilityResults");
                                list.innerHTML = "";

                                data.forEach(x => {
                                    let item = document.createElement("a");
                                    item.className = "list-group-item list-group-item-action";
                                    item.textContent = x.name;
                                    item.onclick = function () {
                                        selectFacility(x.id, x.name);
                                    };
                                    list.appendChild(item);
                                });
                            });
                    }

                    function selectFacility(id, name) {
                        document.getElementById("facilitySearch").value = name;
                        document.getElementById("selectedFacilityId").value = id;
                        document.getElementById("facilityResults").innerHTML = "";
                        loadAshasByFacility(id);
                    }

                            function loadAshasByFacility(facilityId) {
                        fetch(`/AshaOrientation/GetAshasByFacility?facilityId=${facilityId}`)
                            .then(res => res.json())
                            .then(data => {

                                let tbody = document.getElementById("ashaListBody");
                                tbody.innerHTML = "";

                                data.forEach(x => {
                                    let row = document.createElement("tr");

                                    row.innerHTML = `
                                        <td>
                                            <input type="checkbox" class="asha-check"
                                                   data-id="${x.ashaId}"
                                                   data-facilityid="${x.facilityId}"
                                                   data-name="${x.ashaName}"
                                                   data-mobile="${x.ashaMobile || ''}"
                                                   data-facilityname="${x.facilityName || ''}"
                                                   data-subcenter="${x.subCentre || ''}" />
                                        </td>
                                        <td>${x.ashaName}</td>
                                        <td>${x.ashaMobile || '-'}</td>
                                        <td>${x.facilityName || '-'}</td>
                                        <td>${x.subCenter || '-'}</td>
                                    `;

                                    tbody.appendChild(row);
                                });
                            });
                    }
                    // ---------------- CASCADING DROPDOWNS ----------------

                            function loadDistricts(stateId, selectedDistrictId) {
                    fetch(`/AshaOrientation/GetDistricts?stateId=${stateId}`)
                        .then(res => res.json())
                        .then(data => {
                            fillDropdown("DistrictId", data, "id", "name");

                            if (selectedDistrictId) {
                                document.getElementById("DistrictId").value = selectedDistrictId;
                                loadBlocks(selectedDistrictId, document.getElementById("hdnBlockId").value);
                            }
                        });
                }

                function loadBlocks(districtId, selectedBlockId) {
                    fetch(`/AshaOrientation/GetBlocks?districtId=${districtId}`)
                        .then(res => res.json())
                        .then(data => {
                            fillDropdown("BlockId", data, "id", "name");

                            if (selectedBlockId) {
                                document.getElementById("BlockId").value = selectedBlockId;
                                loadFacilities(selectedBlockId, document.getElementById("hdnFacilityId").value);
                            }
                        });
                }

                        function loadFacilities(blockId, selectedFacilityId) {
            fetch(`/AshaOrientation/GetFacilities?blockId=${blockId}`)
                .then(res => res.json())
                .then(data => {
                    fillDropdown("FacilityId", data, "id", "name");

                    const isEdit = document.getElementById("isEditMode").value === "1";
                    const isIntervention =
                        document.querySelector('input[name="IsIntervention"]:checked')?.value === "1";

                    if (isEdit) {

                        if (isIntervention && selectedFacilityId) {
                            document.getElementById("FacilityId").value = selectedFacilityId;
                            document.getElementById("FacilityId")
                                .dispatchEvent(new Event("change"));
                        }

                        if (!isIntervention) {
                            document.getElementById("FacilityName").value = "@Model.FacilityName";
                            document.getElementById("NinNumber").value = "@Model.NIN";
                        }
                    }
                });
        }

                                  document.getElementById("FacilityId").addEventListener("change", function () {
                    let facilityId = this.value;

                    if (!facilityId) {
                        document.getElementById("NinNumber").value = "";
                        return;
                    }

                    fetch(`/AshaOrientation/GetFacilityById?facilityId=${facilityId}`)
                        .then(res => res.json())
                        .then(data => {
                            document.getElementById("NinNumber").value = data.ninNumber || "";
                        });
                });


                    function resetDropdown(id, placeholder) {
                        let ddl = document.getElementById(id);
                        ddl.innerHTML = `<option value="">${placeholder}</option>`;
                    }

                    function fillDropdown(id, data, valueField, textField) {
                        let ddl = document.getElementById(id);
                        data.forEach(x => {
                            let opt = document.createElement("option");
                            opt.value = x[valueField];
                            opt.text = x[textField];
                            ddl.appendChild(opt);
                        });
                    }

                                    document.getElementById("modalFacilityType").addEventListener("change", function () {
                        let type = this.value;

                        let facilityDiv = document.getElementById("modalFacilityDiv");
                        //let ashaDropdownDiv = document.getElementById("modalAshaDropdownDiv");
                        let facilitytextDiv = document.getElementById("modalfacilityTextDiv");
                        let ashaTextDiv = document.getElementById("modalAshaTextDiv");
                        let ashaMobDiv = document.getElementById("modalAshaMobDiv");

                    document.getElementById("modalFacilityDiv").classList.toggle("d-none", type !== "intervention");
                    document.getElementById("modalAshaListDiv").classList.toggle("d-none", type !== "intervention");
                    document.getElementById("modalfacilityTextDiv").classList.toggle("d-none", type !== "non-intervention");
                    document.getElementById("modalAshaTextDiv").classList.toggle("d-none", type !== "non-intervention");
                    document.getElementById("modalAshaMobDiv").classList.toggle("d-none", type !== "non-intervention");

                        if (type === "intervention") {
                            facilityDiv.classList.remove("d-none");
                            //ashaDropdownDiv.classList.remove("d-none");
                            facilitytextDiv.classList.add("d-none");
                            ashaTextDiv.classList.add("d-none");
                            ashaMobDiv.classList.add("d-none");
                        }
                        else if (type === "non-intervention") {
                            facilityDiv.classList.add("d-none");
                            //ashaDropdownDiv.classList.add("d-none");
                            facilitytextDiv.classList.remove("d-none");
                            ashaTextDiv.classList.remove("d-none");
                            ashaMobDiv.classList.remove("d-none");
                        }
                        else {
                            facilityDiv.classList.add("d-none");
                            //ashaDropdownDiv.classList.add("d-none");
                            facilitytextDiv.classList.add("d-none");
                            ashaTextDiv.classList.add("d-none");
                            ashaMobDiv.classList.add("d-none");
                        }
                    });

                            function saveOrientation() {

                                        let selectedTopicIds = Array.from(
                        document.querySelectorAll(".topic-checkbox:checked")
                    ).map(x => x.value);

                                    let facilitySelect = document.getElementById("FacilityId");
                    let selectedFacilityName =
                        facilitySelect.selectedIndex > 0
                            ? facilitySelect.options[facilitySelect.selectedIndex].text
                            : null;

                        let model = {
                                            VenueGuid: document.getElementById("VenueGuid").value,
                            StateId: document.getElementById("StateId").value,
                            DistrictId: document.getElementById("DistrictId").value,
                            BlockId: document.getElementById("BlockId").value,
                            FacilityId: document.getElementById("FacilityId").value || null,
                            FacilityName: selectedFacilityName || document.querySelector('[name="FacilityName"]')?.value,
                            Venue: document.querySelector('[name="FacilityName"]')?.value || null,
                            IsIntervention: document.querySelector('input[name="IsIntervention"]:checked').value,
                            DateofOrientation: document.querySelector('[name="DateofOrientation"]').value,
                            NIN: document.getElementById("NinNumber").value || null,
                            TopicsCovered: selectedTopicIds,
                            Attendees: []
                        };

                        document.querySelectorAll("#ashaRows tr").forEach(row => {
                            let attendee = {
                                AshaId: row.querySelector('.ashaIdHidden')?.value || null,
                                        VenueGuid: row.querySelector('.VenueGuid')?.value || null,
                                AshaName: row.querySelector('.ashaNameInput')?.value || null,
                                VenueName: row.querySelector('.venueInput')?.value || null,
                                AshaMobile: row.querySelector('.mobileInput')?.value || null,
                                VCAT_PreTest: row.querySelector('[name*="VCAT_PreTest"]')?.value || null,
                                VCAT_PostTest: row.querySelector('[name*="VCAT_PostTest"]')?.value || null,
                                IsOrientation: row.querySelector('[type="checkbox"]')?.checked ? 1 : 0
                            };

                            model.Attendees.push(attendee);
                        });

                            fetch('/AshaOrientation/UpdateJson', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
                            },
                            body: JSON.stringify(model)
                        })
                        .then(res => res.json())
                        .then(data => {
                            if (data.success) {
                                alert("Saved successfully!");
                                window.location.href = "/AshaOrientation/Index";
                            } else {
                                alert("Save failed");
                            }
                        })
                        .catch(err => {
                            console.error(err);
                            alert("Error occurred");
                        });
                    }

                                function resetAshaModal() {

                        document.getElementById("modalFacilityType").value = "";

                        document.getElementById("facilitySearch").value = "";
                        document.getElementById("selectedFacilityId").value = "";

                        document.getElementById("facilityResults").innerHTML = "";
                        document.getElementById("ashaListBody").innerHTML = "";

                        document.getElementById("modalFacilityDiv").classList.add("d-none");
                        document.getElementById("modalAshaListDiv").classList.add("d-none");
                        document.getElementById("modalfacilityTextDiv").classList.add("d-none");
                        document.getElementById("modalAshaTextDiv").classList.add("d-none");
                        document.getElementById("modalAshaMobDiv").classList.add("d-none");
                    }

                    // ---------- LOAD EXISTING DATA (UPDATE MODE) ----------
                    const existingAttendees = @Html.Raw(
                                                                                                                                                                                            System.Text.Json.JsonSerializer.Serialize(Model.Attendees ?? new List<AshaOrientationRowDto>())
                                                                                                                            );

    document.addEventListener("DOMContentLoaded", function () {
        if (existingAttendees.length > 0) {
            existingAttendees.forEach(a => {
                addRowWithData(
                    a.AshaId ?? 0,
                    a.VenueId ?? 0,
                    a.VenueName,
                    a.AshaName,
                    a.AshaMobile
                );

                                // set scores + checkbox
                                const lastRow = document.querySelector("#ashaRows tr:last-child");
                                lastRow.querySelector('[name*="VCAT_PreTest"]').value = a.VCAT_PreTest ?? "";
                                lastRow.querySelector('[name*="VCAT_PostTest"]').value = a.VCAT_PostTest ?? "";
                                lastRow.querySelector('[type="checkbox"]').checked = a.IsOrientation === 1;
                            });
                        }
                    });

                            document.addEventListener("DOMContentLoaded", function () {

                    let topicIds = JSON.parse(
                        document.getElementById("hdnTopics")?.value || "[]"
                    );

                    document.querySelectorAll(".topic-checkbox").forEach(cb => {
                        if (topicIds.includes(parseInt(cb.value))) {
                            cb.checked = true;
                        }
                    });
                            document.querySelectorAll(".topic-checkbox").forEach(cb => {
                    cb.addEventListener("change", updateTopicButtonText);
                });


                    updateTopicButtonText();
                });

                        function updateTopicButtonText() {
                    let checked = document.querySelectorAll(".topic-checkbox:checked");

                    let btn = document.getElementById("topicsDropdownBtn");

                    if (checked.length === 0) {
                        btn.innerText = "Select Topics";
                    } else {
                        btn.innerText = `${checked.length} topic(s) selected`;
                    }
                }

                        document.addEventListener("DOMContentLoaded", function () {

                let isEdit = document.getElementById("isEditMode").value === "1";
                let isInterventionValue = "@Model.IsIntervention";

                if (isEdit) {
                    if (isInterventionValue === "1") {
                        document.getElementById("intervention").checked = true;
                    } else {
                        document.getElementById("nonIntervention").checked = true;
                    }
                } else {
                    document.getElementById("intervention").checked = true; // default for create
                }

                handleFacilityTypeChange();
            });


    </script>
}